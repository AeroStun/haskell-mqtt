<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts   #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances  #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings  #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies       #-}</span><span>
</span><a name="line-6"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Module      :  Network.Stack.Server</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Copyright   :  (c) Lars Petersen 2016</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- License     :  MIT</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Maintainer  :  info@lars-petersen.net</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-14"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Stack</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Async</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span>      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSL</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Typeable</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">X509</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">X509</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Storable</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">TLS</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TLS</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">WebSockets</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">WS</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">WebSockets</span><span class="hs-operator">.</span><span class="hs-identifier">Stream</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">WS</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Socket</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">data</span><span> </span><a name="TLS"><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier">TLS</span></a></a><span> </span><a name="local-1627459864"><a href="#local-1627459864"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-32"></a><span class="hs-keyword">data</span><span> </span><a name="WebSocket"><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier">WebSocket</span></a></a><span> </span><a name="local-1627459863"><a href="#local-1627459863"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="ServerStack"><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier">ServerStack</span></a></a><span> </span><a name="local-1627459860"><a href="#local-1627459860"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-comment">--type ServerMessage a</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><a name="local-1627459860"><a href="#local-1627459860"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><a name="local-1627459860"><a href="#local-1627459860"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><a name="local-1627459860"><a href="#local-1627459860"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><a name="local-1627459860"><a href="#local-1627459860"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnectionInfo</span><span> </span><a name="local-1627459860"><a href="#local-1627459860"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-comment">-- | Creates a new server from a configuration and passes it to a handler function.</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-comment">--   The server given to the handler function shall be bound and in</span><span>
</span><a name="line-44"></a><span>  </span><span class="hs-comment">--   listening state. The handler function is usually a</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-comment">--   `Control.Monad.forever` loop that accepts and handles new connections.</span><span>
</span><a name="line-46"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-47"></a><span>  </span><span class="hs-comment">--   &gt; withServer config $ \server-&gt;</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-comment">--   &gt;   forever $ withConnection handleConnection</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-identifier">withServer</span><span>     </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-1627459861"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-1627459861"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-50"></a><span>  </span><span class="hs-comment">-- | Waits for and accepts a new connection from a listening server and passes</span><span>
</span><a name="line-51"></a><span>  </span><span class="hs-comment">--   it to a handler function.</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-53"></a><span>  </span><span class="hs-comment">--   This operation is blocking until the lowest layer in the stack accepts</span><span>
</span><a name="line-54"></a><span>  </span><span class="hs-comment">--   a new connection. The handlers of all other layers are executed within</span><span>
</span><a name="line-55"></a><span>  </span><span class="hs-comment">--   an `Control.Concurrent.Async.Async` which is returned. This allows</span><span>
</span><a name="line-56"></a><span>  </span><span class="hs-comment">--   the main thread waiting on the underlying socket to block just as long</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-comment">--   as necessary. Upper layer protocol handshakes (TLS etc) will be executed</span><span>
</span><a name="line-58"></a><span>  </span><span class="hs-comment">--   in the new thread.</span><span>
</span><a name="line-59"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-comment">--   &gt; withServer config $ \server-&gt; forever $</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-comment">--   &gt;   future &lt;- withConnection server handleConnection</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-comment">--   &gt;   putStrLn &quot;The lowest layer accepted a new connection!&quot;</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-comment">--   &gt;   async $ do</span><span>
</span><a name="line-64"></a><span>  </span><span class="hs-comment">--   &gt;       result &lt;- wait future</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-comment">--   &gt;       putStrLn &quot;The connection handler returned:&quot;</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-comment">--   &gt;       print result</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-identifier">withConnection</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-1627459862"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-1627459862"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-comment">--flush          :: ServerConnection a -&gt; IO ()</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-comment">--send           :: ServerConnection a -&gt; ServerMessage a -&gt; IO ()</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-comment">--receive        :: ServerConnection a -&gt; Int -&gt; IO (ServerMessage a)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-keyword">class</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><a href="#local-1627459661"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="StreamServerStack"><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier">StreamServerStack</span></a></a><span> </span><a name="local-1627459661"><a href="#local-1627459661"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-identifier">sendStream</span><span>              </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459661"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>  </span><a name="local-1912672284"><a href="Network.Stack.Server.html#sendStream"><span class="hs-identifier">sendStream</span></a></a><span>        </span><a name="local-1627459856"><a href="#local-1627459856"><span class="hs-identifier">server</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#sendStreamLazy"><span class="hs-identifier hs-var">sendStreamLazy</span></a><span> </span><a href="#local-1627459856"><span class="hs-identifier hs-var">server</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-identifier">sendStreamLazy</span><span>          </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459661"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BSL</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>  </span><a name="local-1912672285"><a href="Network.Stack.Server.html#sendStreamLazy"><span class="hs-identifier">sendStreamLazy</span></a></a><span> </span><a name="local-1627459857"><a href="#local-1627459857"><span class="hs-identifier">server</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#sendStream"><span class="hs-identifier hs-var">sendStream</span></a><span> </span><a href="#local-1627459857"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toChunks</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-identifier">receiveStream</span><span>           </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459661"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-78"></a><span>  </span><a name="local-1912672286"><a href="Network.Stack.Server.html#receiveStream"><span class="hs-identifier">receiveStream</span></a></a><span>     </span><a name="local-1627459858"><a href="#local-1627459858"><span class="hs-identifier">server</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toStrict</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Network.Stack.Server.html#receiveStreamLazy"><span class="hs-identifier hs-var">receiveStreamLazy</span></a><span> </span><a href="#local-1627459858"><span class="hs-identifier hs-var">server</span></a><span>
</span><a name="line-79"></a><span>  </span><span class="hs-identifier">receiveStreamLazy</span><span>       </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459661"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">BSL</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-80"></a><span>  </span><a name="local-1912672287"><a href="Network.Stack.Server.html#receiveStreamLazy"><span class="hs-identifier">receiveStreamLazy</span></a></a><span> </span><a name="local-1627459859"><a href="#local-1627459859"><span class="hs-identifier">server</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Network.Stack.Server.html#receiveStream"><span class="hs-identifier hs-var">receiveStream</span></a><span> </span><a href="#local-1627459859"><span class="hs-identifier hs-var">server</span></a><span>
</span><a name="line-81"></a><span>  </span><span class="hs-pragma">{-# MINIMAL (sendStream|sendStreamLazy), (receiveStream|receiveStreamLazy) #-}</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-keyword">class</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><a href="#local-1627459660"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="MessageServerStack"><a href="Network.Stack.Server.html#MessageServerStack"><span class="hs-identifier">MessageServerStack</span></a></a><span> </span><a name="local-1627459660"><a href="#local-1627459660"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Message</span><span> </span><a name="local-1627459660"><a href="#local-1627459660"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-85"></a><span>  </span><span class="hs-identifier">sendMessage</span><span>             </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459660"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Stack.Server.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><a href="#local-1627459660"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-identifier">receiveMessage</span><span>          </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459660"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><a href="#local-1627459660"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461838"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461839"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461840"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Storable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketAddress</span><span> </span><a href="#local-1627461838"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Family</span><span> </span><a href="#local-1627461838"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Type</span><span> </span><a href="#local-1627461839"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Protocol</span><span> </span><a href="#local-1627461840"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier hs-type">StreamServerStack</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461838"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461839"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461840"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-89"></a><span>  </span><a name="local-1912672284"><a href="Network.Stack.Server.html#sendStream"><span class="hs-identifier">sendStream</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier hs-var">SocketServerConnection</span></a><span> </span><a name="local-1627461841"><a href="#local-1627461841"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627461842"><span class="hs-identifier hs-var">sendAll</span></a><span>
</span><a name="line-90"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-91"></a><span>      </span><a name="local-1627461842"><a href="#local-1627461842"><span class="hs-identifier">sendAll</span></a></a><span> </span><a name="local-1627461843"><a href="#local-1627461843"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-92"></a><span>        </span><a name="local-1627462013"><a href="#local-1627462013"><span class="hs-identifier">sent</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">send</span><span> </span><a href="#local-1627461841"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1627461843"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">msgNoSignal</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-1627462013"><span class="hs-identifier hs-var">sent</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627461843"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627461842"><span class="hs-identifier hs-var">sendAll</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-1627462013"><span class="hs-identifier hs-var">sent</span></a><span> </span><a href="#local-1627461843"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>  </span><a name="local-1912672286"><a href="Network.Stack.Server.html#receiveStream"><span class="hs-identifier">receiveStream</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier hs-var">SocketServerConnection</span></a><span> </span><a name="local-1627462014"><a href="#local-1627462014"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">receive</span><span> </span><a href="#local-1627462014"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-number">4096</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">msgNoSignal</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier hs-type">StreamServerStack</span></a><span> </span><a href="#local-1627461835"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier hs-type">StreamServerStack</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627461835"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>  </span><a name="local-1912672285"><a href="Network.Stack.Server.html#sendStreamLazy"><span class="hs-identifier">sendStreamLazy</span></a></a><span>    </span><a name="local-1627461836"><a href="#local-1627461836"><span class="hs-identifier">connection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendData</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier">tlsContext</span><span>   </span><a href="#local-1627461836"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>  </span><a name="local-1912672286"><a href="Network.Stack.Server.html#receiveStream"><span class="hs-identifier">receiveStream</span></a></a><span>     </span><a name="local-1627461837"><a href="#local-1627461837"><span class="hs-identifier">connection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">recvData</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier">tlsContext</span><span>   </span><a href="#local-1627461837"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier hs-type">StreamServerStack</span></a><span> </span><a href="#local-1627461831"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier hs-type">StreamServerStack</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627461831"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-101"></a><span>  </span><a name="local-1912672284"><a href="Network.Stack.Server.html#sendStream"><span class="hs-identifier">sendStream</span></a></a><span>        </span><a name="local-1627461832"><a href="#local-1627461832"><span class="hs-identifier">connection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendBinaryData</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsConnection</span><span> </span><a href="#local-1627461832"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>  </span><a name="local-1912672285"><a href="Network.Stack.Server.html#sendStreamLazy"><span class="hs-identifier">sendStreamLazy</span></a></a><span>    </span><a name="local-1627461833"><a href="#local-1627461833"><span class="hs-identifier">connection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendBinaryData</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsConnection</span><span> </span><a href="#local-1627461833"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>  </span><a name="local-1912672287"><a href="Network.Stack.Server.html#receiveStreamLazy"><span class="hs-identifier">receiveStreamLazy</span></a></a><span> </span><a name="local-1627461834"><a href="#local-1627461834"><span class="hs-identifier">connection</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">receiveData</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">wsConnection</span><span> </span><a href="#local-1627461834"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketAddress</span><span> </span><a href="#local-1627462017"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627462017"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627462018"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627462019"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><a href="#local-1627462016"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627462016"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><a href="#local-1627462015"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627462015"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Storable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketAddress</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Family</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Type</span><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Protocol</span><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-comment">--type ServerMessage (S.Socket f t p) = BS.ByteString</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServer"><a href="Network.Stack.Server.html#SocketServer"><span class="hs-identifier">SocketServer</span></a></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="socketServer"><a href="Network.Stack.Server.html#socketServer"><span class="hs-identifier">socketServer</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="socketServerConfig"><a href="Network.Stack.Server.html#socketServerConfig"><span class="hs-identifier">socketServerConfig</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServerConfig"><a href="Network.Stack.Server.html#SocketServerConfig"><span class="hs-identifier">SocketServerConfig</span></a></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="socketServerConfigBindAddress"><a href="Network.Stack.Server.html#socketServerConfigBindAddress"><span class="hs-identifier">socketServerConfigBindAddress</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketAddress</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="socketServerConfigListenQueueSize"><a href="Network.Stack.Server.html#socketServerConfigListenQueueSize"><span class="hs-identifier">socketServerConfigListenQueueSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-118"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServerException"><a href="Network.Stack.Server.html#SocketServerException"><span class="hs-identifier">SocketServerException</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketException</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServerConnection"><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier">SocketServerConnection</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnectionInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461048"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461049"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServerConnectionInfo"><a href="Network.Stack.Server.html#SocketServerConnectionInfo"><span class="hs-identifier">SocketServerConnectionInfo</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketAddress</span><span> </span><a href="#local-1627461047"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>  </span><a name="local-1912672294"><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier">withServer</span></a></a><span> </span><a name="local-1627461263"><a href="#local-1627461263"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-1627461264"><a href="#local-1627461264"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bracket</span><span>
</span><a name="line-123"></a><span>    </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServer"><span class="hs-identifier hs-var">SocketServer</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">socket</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-1627461263"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">close</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">socketServer</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627461588"><a href="#local-1627461588"><span class="hs-identifier">server</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-125"></a><span>      </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServer</span><span> </span><a href="#local-1627461588"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServerConfigBindAddress</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">socketServerConfig</span><span> </span><a href="#local-1627461588"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>      </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">listen</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServer</span><span> </span><a href="#local-1627461588"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServerConfigListenQueueSize</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">socketServerConfig</span><span> </span><a href="#local-1627461588"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>      </span><a href="#local-1627461264"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-1627461588"><span class="hs-identifier hs-var">server</span></a><span>
</span><a name="line-128"></a><span>  </span><a name="local-1912672295"><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-1627461589"><a href="#local-1627461589"><span class="hs-identifier">server</span></a></a><span> </span><a name="local-1627461590"><a href="#local-1627461590"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bracketOnError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">accept</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServer</span><span> </span><a href="#local-1627461589"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">close</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627461591"><a href="#local-1627461591"><span class="hs-identifier">connection</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627461592"><a href="#local-1627461592"><span class="hs-identifier">addr</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-130"></a><span>      </span><span class="hs-identifier hs-var">async</span><span> </span><span class="hs-special">(</span><a href="#local-1627461590"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier hs-var">SocketServerConnection</span></a><span> </span><a href="#local-1627461591"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServerConnectionInfo"><span class="hs-identifier hs-var">SocketServerConnectionInfo</span></a><span> </span><a href="#local-1627461592"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">finally</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">close</span><span> </span><a href="#local-1627461591"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span>  </span><span class="hs-comment">{-flush =
    const (pure ())
  send (SocketServerConnection s) = sendAll
    where
      sendAll bs = do
        sent &lt;- S.send s bs S.msgNoSignal
        when (sent &lt; BS.length bs) $ sendAll (BS.drop sent bs)
  receive (SocketServerConnection s) i = S.receive s i S.msgNoSignal -}</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier hs-type">StreamServerStack</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-141"></a><span>  </span><span class="hs-comment">--type ServerMessage (TLS a) = BS.ByteString</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServer"><a href="Network.Stack.Server.html#TlsServer"><span class="hs-identifier">TlsServer</span></a></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tlsTransportServer"><a href="Network.Stack.Server.html#tlsTransportServer"><span class="hs-identifier">tlsTransportServer</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsServerConfig"><a href="Network.Stack.Server.html#tlsServerConfig"><span class="hs-identifier">tlsServerConfig</span></a></a><span>               </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-146"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServerConfig"><a href="Network.Stack.Server.html#TlsServerConfig"><span class="hs-identifier">TlsServerConfig</span></a></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tlsTransportConfig"><a href="Network.Stack.Server.html#tlsTransportConfig"><span class="hs-identifier">tlsTransportConfig</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsServerParams"><a href="Network.Stack.Server.html#tlsServerParams"><span class="hs-identifier">tlsServerParams</span></a></a><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TLS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ServerParams</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-150"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServerException"><a href="Network.Stack.Server.html#TlsServerException"><span class="hs-identifier">TlsServerException</span></a></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServerConnection"><a href="Network.Stack.Server.html#TlsServerConnection"><span class="hs-identifier">TlsServerConnection</span></a></a><span>
</span><a name="line-152"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tlsTransportConnection"><a href="Network.Stack.Server.html#tlsTransportConnection"><span class="hs-identifier">tlsTransportConnection</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-153"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsContext"><a href="Network.Stack.Server.html#tlsContext"><span class="hs-identifier">tlsContext</span></a></a><span>                    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TLS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Context</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnectionInfo</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServerConnectionInfo"><a href="Network.Stack.Server.html#TlsServerConnectionInfo"><span class="hs-identifier">TlsServerConnectionInfo</span></a></a><span>
</span><a name="line-156"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tlsTransportServerConnectionInfo"><a href="Network.Stack.Server.html#tlsTransportServerConnectionInfo"><span class="hs-identifier">tlsTransportServerConnectionInfo</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><a href="#local-1627460340"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-157"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsCertificateChain"><a href="Network.Stack.Server.html#tlsCertificateChain"><span class="hs-identifier">tlsCertificateChain</span></a></a><span>              </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">X509</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">CertificateChain</span><span>
</span><a name="line-158"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-159"></a><span>  </span><a name="local-1912672294"><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier">withServer</span></a></a><span> </span><a name="local-1627460341"><a href="#local-1627460341"><span class="hs-identifier">config</span></a></a><span> </span><a name="local-1627460342"><a href="#local-1627460342"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-160"></a><span>    </span><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier hs-var">withServer</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsTransportConfig</span><span> </span><a href="#local-1627460341"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627460343"><a href="#local-1627460343"><span class="hs-identifier">server</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-161"></a><span>      </span><a href="#local-1627460342"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TlsServer"><span class="hs-identifier hs-var">TlsServer</span></a><span> </span><a href="#local-1627460343"><span class="hs-identifier hs-var">server</span></a><span> </span><a href="#local-1627460341"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>  </span><a name="local-1912672295"><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-1627460344"><a href="#local-1627460344"><span class="hs-identifier">server</span></a></a><span> </span><a name="local-1627460345"><a href="#local-1627460345"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-163"></a><span>    </span><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsTransportServer</span><span> </span><a href="#local-1627460344"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627460346"><a href="#local-1627460346"><span class="hs-identifier">connection</span></a></a><span> </span><a name="local-1627460347"><a href="#local-1627460347"><span class="hs-identifier">info</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-164"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627460348"><a href="#local-1627460348"><span class="hs-identifier">backend</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Backend</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-165"></a><span>          </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendFlush</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendClose</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- backend gets closed automatically</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendSend</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#sendStream"><span class="hs-identifier hs-var">sendStream</span></a><span> </span><a href="#local-1627460346"><span class="hs-identifier hs-var">connection</span></a><span>
</span><a name="line-168"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendRecv</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#receiveStream"><span class="hs-identifier hs-var">receiveStream</span></a><span> </span><a href="#local-1627460346"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-170"></a><span>      </span><a name="local-1627460408"><a href="#local-1627460408"><span class="hs-identifier">mvar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-171"></a><span>      </span><a name="local-1627460466"><a href="#local-1627460466"><span class="hs-identifier">context</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextNew</span><span> </span><a href="#local-1627460348"><span class="hs-identifier hs-var">backend</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsServerParams</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tlsServerConfig</span><span> </span><a href="#local-1627460344"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>      </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextHookSetCertificateRecv</span><span> </span><a href="#local-1627460466"><span class="hs-identifier hs-var">context</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-1627460408"><span class="hs-identifier hs-var">mvar</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>      </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">handshake</span><span> </span><a href="#local-1627460466"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-174"></a><span>      </span><a name="local-1627460479"><a href="#local-1627460479"><span class="hs-identifier">certificateChain</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryTakeMVar</span><span> </span><a href="#local-1627460408"><span class="hs-identifier hs-var">mvar</span></a><span>
</span><a name="line-175"></a><span>      </span><a name="local-1627460480"><a href="#local-1627460480"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627460345"><span class="hs-identifier hs-var">handle</span></a><span>
</span><a name="line-176"></a><span>        </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TlsServerConnection"><span class="hs-identifier hs-var">TlsServerConnection</span></a><span> </span><a href="#local-1627460346"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-1627460466"><span class="hs-identifier hs-var">context</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>        </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TlsServerConnectionInfo"><span class="hs-identifier hs-var">TlsServerConnectionInfo</span></a><span> </span><a href="#local-1627460347"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-1627460479"><span class="hs-identifier hs-var">certificateChain</span></a><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>      </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bye</span><span> </span><a href="#local-1627460466"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-179"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-1627460480"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-180"></a><span>  </span><span class="hs-comment">{-flush conn     = TLS.contextFlush (tlsContext conn)
  send conn bs   = TLS.sendData     (tlsContext conn) (BSL.fromStrict bs)
  receive conn _ = TLS.recvData     (tlsContext conn) -}</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#StreamServerStack"><span class="hs-identifier hs-type">StreamServerStack</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-185"></a><span>  </span><span class="hs-comment">--type ServerMessage (WebSocket a) = BS.ByteString</span><span>
</span><a name="line-186"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServer"><a href="Network.Stack.Server.html#WebSocketServer"><span class="hs-identifier">WebSocketServer</span></a></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wsTransportServer"><a href="Network.Stack.Server.html#wsTransportServer"><span class="hs-identifier">wsTransportServer</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-188"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServerConfig"><a href="Network.Stack.Server.html#WebSocketServerConfig"><span class="hs-identifier">WebSocketServerConfig</span></a></a><span>
</span><a name="line-190"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wsTransportConfig"><a href="Network.Stack.Server.html#wsTransportConfig"><span class="hs-identifier">wsTransportConfig</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-191"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-192"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServerException"><a href="Network.Stack.Server.html#WebSocketServerException"><span class="hs-identifier">WebSocketServerException</span></a></a><span>
</span><a name="line-193"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServerConnection"><a href="Network.Stack.Server.html#WebSocketServerConnection"><span class="hs-identifier">WebSocketServerConnection</span></a></a><span>
</span><a name="line-194"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wsTransportConnection"><a href="Network.Stack.Server.html#wsTransportConnection"><span class="hs-identifier">wsTransportConnection</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-195"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="wsConnection"><a href="Network.Stack.Server.html#wsConnection"><span class="hs-identifier">wsConnection</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Connection</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-197"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnectionInfo</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServerConnectionInfo"><a href="Network.Stack.Server.html#WebSocketServerConnectionInfo"><span class="hs-identifier">WebSocketServerConnectionInfo</span></a></a><span>
</span><a name="line-198"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wsTransportServerConnectionInfo"><a href="Network.Stack.Server.html#wsTransportServerConnectionInfo"><span class="hs-identifier">wsTransportServerConnectionInfo</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnectionInfo"><span class="hs-identifier hs-type">ServerConnectionInfo</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-199"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="wsRequestHead"><a href="Network.Stack.Server.html#wsRequestHead"><span class="hs-identifier">wsRequestHead</span></a></a><span>                   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">RequestHead</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-201"></a><span>  </span><a name="local-1912672294"><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier">withServer</span></a></a><span> </span><a name="local-1627459866"><a href="#local-1627459866"><span class="hs-identifier">config</span></a></a><span> </span><a name="local-1627459867"><a href="#local-1627459867"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-202"></a><span>    </span><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier hs-var">withServer</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsTransportConfig</span><span> </span><a href="#local-1627459866"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459868"><a href="#local-1627459868"><span class="hs-identifier">server</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-203"></a><span>      </span><a href="#local-1627459867"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocketServer"><span class="hs-identifier hs-var">WebSocketServer</span></a><span> </span><a href="#local-1627459868"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>  </span><a name="local-1912672295"><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-1627459869"><a href="#local-1627459869"><span class="hs-identifier">server</span></a></a><span> </span><a name="local-1627459870"><a href="#local-1627459870"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-205"></a><span>    </span><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsTransportServer</span><span> </span><a href="#local-1627459869"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459871"><a href="#local-1627459871"><span class="hs-identifier">connection</span></a></a><span> </span><a name="local-1627459872"><a href="#local-1627459872"><span class="hs-identifier">info</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-206"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627459873"><a href="#local-1627459873"><span class="hs-identifier">readSocket</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627459874"><a href="#local-1627459874"><span class="hs-identifier">bs</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-1627459874"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627459874"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Network.Stack.Server.html#receiveStream"><span class="hs-identifier hs-var">receiveStream</span></a><span> </span><a href="#local-1627459871"><span class="hs-identifier hs-var">connection</span></a><span>
</span><a name="line-207"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627459875"><a href="#local-1627459875"><span class="hs-identifier">writeSocket</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-208"></a><span>          </span><span class="hs-identifier">writeSocket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627459876"><a href="#local-1627459876"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#sendStream"><span class="hs-identifier hs-var">sendStream</span></a><span> </span><a href="#local-1627459871"><span class="hs-identifier hs-var">connection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toStrict</span><span> </span><a href="#local-1627459876"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>      </span><a name="local-1627459877"><a href="#local-1627459877"><span class="hs-identifier">stream</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">makeStream</span><span> </span><a href="#local-1627459873"><span class="hs-identifier hs-var">readSocket</span></a><span> </span><a href="#local-1627459875"><span class="hs-identifier hs-var">writeSocket</span></a><span>
</span><a name="line-210"></a><span>      </span><a name="local-1627460102"><a href="#local-1627460102"><span class="hs-identifier">pendingConnection</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">makePendingConnectionFromStream</span><span> </span><a href="#local-1627459877"><span class="hs-identifier hs-var">stream</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ConnectionOptions</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>      </span><a name="local-1627460103"><a href="#local-1627460103"><span class="hs-identifier">acceptedConnection</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">acceptRequest</span><span> </span><a href="#local-1627460102"><span class="hs-identifier hs-var">pendingConnection</span></a><span>
</span><a name="line-212"></a><span>      </span><a name="local-1627460104"><a href="#local-1627460104"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627459870"><span class="hs-identifier hs-var">handle</span></a><span>
</span><a name="line-213"></a><span>        </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocketServerConnection"><span class="hs-identifier hs-var">WebSocketServerConnection</span></a><span> </span><a href="#local-1627459871"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-1627460103"><span class="hs-identifier hs-var">acceptedConnection</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>        </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocketServerConnectionInfo"><span class="hs-identifier hs-var">WebSocketServerConnectionInfo</span></a><span> </span><a href="#local-1627459872"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">WS</span><span class="hs-operator">.</span><span class="hs-identifier">pendingRequest</span><span> </span><a href="#local-1627460102"><span class="hs-identifier hs-var">pendingConnection</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>      </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendClose</span><span> </span><a href="#local-1627460103"><span class="hs-identifier hs-var">acceptedConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Thank you for flying Haskell.&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-1627460104"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-217"></a><span>  </span><span class="hs-comment">{-flush conn     = flush (wsTransportConnection conn)
  send conn      = WS.sendBinaryData (wsConnection conn)
  receive conn _ = WS.receiveData (wsConnection conn) -}</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-comment">{-
instance Request (ServerConnection (S.Socket f t p)) where

instance (Request (ServerConnection a)) =&gt; Request (ServerConnection (TLS a)) where
  requestSecure             = const True
  requestCertificateChain   = tlsCertificateChain
  requestHeaders a          = requestHeaders (tlsTransportConnection a)

instance (Request (ServerConnection a)) =&gt; Request (ServerConnection (WebSocket a)) where
  requestSecure conn        = requestSecure (wsTransportConnection conn)
  requestCertificateChain a = requestCertificateChain (wsTransportConnection a)
  requestHeaders conn       = WS.requestHeaders $ WS.pendingRequest (wsPendingConnection conn)
-}</span><span>
</span><a name="line-234"></a></pre></body></html>