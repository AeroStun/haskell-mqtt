<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies      #-}</span><span>
</span><a name="line-5"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Module      :  Network.MQTT.ServerStack</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Copyright   :  (c) Lars Petersen 2016</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- License     :  MIT</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Maintainer  :  info@lars-petersen.net</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-13"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Stack</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">where</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">Async</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSL</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Typeable</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">X509</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">X509</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">Storable</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.Authentication.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Authentication</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">TLS</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TLS</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">WebSockets</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">WS</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">WebSockets</span><span class="hs-operator">.</span><span class="hs-identifier">Stream</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">WS</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Socket</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">data</span><span> </span><a name="TLS"><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier">TLS</span></a></a><span> </span><a name="local-1627459598"><a href="#local-1627459598"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-34"></a><span class="hs-keyword">data</span><span> </span><a name="WebSocket"><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier">WebSocket</span></a></a><span> </span><a name="local-1627459597"><a href="#local-1627459597"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">class</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="ServerStack"><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier">ServerStack</span></a></a><span> </span><a name="local-1627459594"><a href="#local-1627459594"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-37"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">ServerMessage</span><span> </span><a name="local-1627459594"><a href="#local-1627459594"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><a name="local-1627459594"><a href="#local-1627459594"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><a name="local-1627459594"><a href="#local-1627459594"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><a name="local-1627459594"><a href="#local-1627459594"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><a name="local-1627459594"><a href="#local-1627459594"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-comment">-- | Creates a new server from a configuration and passes it to a handler function.</span><span>
</span><a name="line-43"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-44"></a><span>  </span><span class="hs-comment">--   The server given to the handler function shall be bound and in</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-comment">--   listening state. The handler function is usually a</span><span>
</span><a name="line-46"></a><span>  </span><span class="hs-comment">--   `Control.Monad.forever` loop that accepts and handles new connections.</span><span>
</span><a name="line-47"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-comment">--   &gt; withServer config $ \server-&gt;</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-comment">--   &gt;   forever $ withConnection handleConnection</span><span>
</span><a name="line-50"></a><span>  </span><span class="hs-identifier">withServer</span><span>     </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-1627459595"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-1627459595"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-comment">-- | Waits for and accepts a new connection from a listening server and passes</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-comment">--   it to a handler function.</span><span>
</span><a name="line-53"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-54"></a><span>  </span><span class="hs-comment">--   This operation is blocking until the lowest layer in the stack accepts</span><span>
</span><a name="line-55"></a><span>  </span><span class="hs-comment">--   a new connection. The handlers of all other layers are executed within</span><span>
</span><a name="line-56"></a><span>  </span><span class="hs-comment">--   an `Control.Concurrent.Async.Async` which is returned. This allows</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-comment">--   the main thread waiting on the underlying socket to block just as long</span><span>
</span><a name="line-58"></a><span>  </span><span class="hs-comment">--   as necessary. Upper layer protocol handshakes (TLS etc) will be executed</span><span>
</span><a name="line-59"></a><span>  </span><span class="hs-comment">--   in a new thread.</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-comment">--   &gt; withServer config $ \server-&gt; forever $</span><span>
</span><a name="line-62"></a><span>  </span><span class="hs-comment">--   &gt;   future &lt;- withConnection server handleConnection</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-comment">--   &gt;   putStrLn &quot;The lowest layer accepted a new connection!&quot;</span><span>
</span><a name="line-64"></a><span>  </span><span class="hs-comment">--   &gt;   async $ do</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-comment">--   &gt;       result &lt;- wait future</span><span>
</span><a name="line-66"></a><span>  </span><span class="hs-comment">--   &gt;       putStrLn &quot;The connection handler returned:&quot;</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-comment">--   &gt;       print result</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-identifier">withConnection</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-1627459596"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-1627459596"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-identifier">flush</span><span>          </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-identifier">send</span><span>           </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerMessage"><span class="hs-identifier hs-type">ServerMessage</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-identifier">receive</span><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerMessage"><span class="hs-identifier hs-type">ServerMessage</span></a><span> </span><a href="#local-1627459594"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Storable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketAddress</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Family</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Type</span><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Protocol</span><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-74"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">ServerMessage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServer"><a href="Network.Stack.Server.html#SocketServer"><span class="hs-identifier">SocketServer</span></a></a><span>
</span><a name="line-76"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="socketServer"><a href="Network.Stack.Server.html#socketServer"><span class="hs-identifier">socketServer</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="socketServerConfig"><a href="Network.Stack.Server.html#socketServerConfig"><span class="hs-identifier">socketServerConfig</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServerConfig"><a href="Network.Stack.Server.html#SocketServerConfig"><span class="hs-identifier">SocketServerConfig</span></a></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="socketServerConfigBindAddress"><a href="Network.Stack.Server.html#socketServerConfigBindAddress"><span class="hs-identifier">socketServerConfigBindAddress</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketAddress</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="socketServerConfigListenQueueSize"><a href="Network.Stack.Server.html#socketServerConfigListenQueueSize"><span class="hs-identifier">socketServerConfigListenQueueSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-83"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServerException"><a href="Network.Stack.Server.html#SocketServerException"><span class="hs-identifier">SocketServerException</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">SocketException</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="SocketServerConnection"><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier">SocketServerConnection</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627461008"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627461009"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627461010"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>  </span><a name="local-1912672230"><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier">withServer</span></a></a><span> </span><a name="local-1627461011"><a href="#local-1627461011"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-1627461012"><a href="#local-1627461012"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bracket</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServer"><span class="hs-identifier hs-var">SocketServer</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">socket</span><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-1627461011"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">close</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">socketServer</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627461336"><a href="#local-1627461336"><span class="hs-identifier">server</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServer</span><span> </span><a href="#local-1627461336"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServerConfigBindAddress</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">socketServerConfig</span><span> </span><a href="#local-1627461336"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>      </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">listen</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServer</span><span> </span><a href="#local-1627461336"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServerConfigListenQueueSize</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">socketServerConfig</span><span> </span><a href="#local-1627461336"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>      </span><a href="#local-1627461012"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-1627461336"><span class="hs-identifier hs-var">server</span></a><span>
</span><a name="line-91"></a><span>  </span><a name="local-1912672231"><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-1627461337"><a href="#local-1627461337"><span class="hs-identifier">server</span></a></a><span> </span><a name="local-1627461338"><a href="#local-1627461338"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bracketOnError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">accept</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">socketServer</span><span> </span><a href="#local-1627461337"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">close</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627461339"><a href="#local-1627461339"><span class="hs-identifier">connection</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-93"></a><span>      </span><span class="hs-identifier hs-var">async</span><span> </span><span class="hs-special">(</span><a href="#local-1627461338"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier hs-var">SocketServerConnection</span></a><span> </span><a href="#local-1627461339"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">E</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">finally</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">close</span><span> </span><a href="#local-1627461339"><span class="hs-identifier hs-var">connection</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>  </span><a name="local-1912672232"><a href="Network.Stack.Server.html#flush"><span class="hs-identifier">flush</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-95"></a><span>    </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>  </span><a name="local-1912672233"><a href="Network.Stack.Server.html#send"><span class="hs-identifier">send</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier hs-var">SocketServerConnection</span></a><span> </span><a name="local-1627461340"><a href="#local-1627461340"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627461341"><span class="hs-identifier hs-var">sendAll</span></a><span>
</span><a name="line-97"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>      </span><a name="local-1627461341"><a href="#local-1627461341"><span class="hs-identifier">sendAll</span></a></a><span> </span><a name="local-1627461342"><a href="#local-1627461342"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-99"></a><span>        </span><a name="local-1627461512"><a href="#local-1627461512"><span class="hs-identifier">sent</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">send</span><span> </span><a href="#local-1627461340"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1627461342"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">msgNoSignal</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-1627461512"><span class="hs-identifier hs-var">sent</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-1627461342"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627461341"><span class="hs-identifier hs-var">sendAll</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-1627461512"><span class="hs-identifier hs-var">sent</span></a><span> </span><a href="#local-1627461342"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>  </span><a name="local-1912672234"><a href="Network.Stack.Server.html#receive"><span class="hs-identifier">receive</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#SocketServerConnection"><span class="hs-identifier hs-var">SocketServerConnection</span></a><span> </span><a name="local-1627461513"><a href="#local-1627461513"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627461514"><a href="#local-1627461514"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">receive</span><span> </span><a href="#local-1627461513"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-1627461514"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-identifier hs-var">S</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">msgNoSignal</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="Network.Stack.Server.html#ServerMessage"><span class="hs-identifier hs-type">ServerMessage</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">ServerMessage</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#ServerMessage"><span class="hs-identifier hs-type">ServerMessage</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-105"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServer"><a href="Network.Stack.Server.html#TlsServer"><span class="hs-identifier">TlsServer</span></a></a><span>
</span><a name="line-106"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tlsTransportServer"><a href="Network.Stack.Server.html#tlsTransportServer"><span class="hs-identifier">tlsTransportServer</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsServerConfig"><a href="Network.Stack.Server.html#tlsServerConfig"><span class="hs-identifier">tlsServerConfig</span></a></a><span>               </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-109"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServerConfig"><a href="Network.Stack.Server.html#TlsServerConfig"><span class="hs-identifier">TlsServerConfig</span></a></a><span>
</span><a name="line-110"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tlsTransportConfig"><a href="Network.Stack.Server.html#tlsTransportConfig"><span class="hs-identifier">tlsTransportConfig</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-111"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsServerParams"><a href="Network.Stack.Server.html#tlsServerParams"><span class="hs-identifier">tlsServerParams</span></a></a><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TLS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ServerParams</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServerException"><a href="Network.Stack.Server.html#TlsServerException"><span class="hs-identifier">TlsServerException</span></a></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="TlsServerConnection"><a href="Network.Stack.Server.html#TlsServerConnection"><span class="hs-identifier">TlsServerConnection</span></a></a><span>
</span><a name="line-115"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tlsTransportConnection"><a href="Network.Stack.Server.html#tlsTransportConnection"><span class="hs-identifier">tlsTransportConnection</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627460298"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsContext"><a href="Network.Stack.Server.html#tlsContext"><span class="hs-identifier">tlsContext</span></a></a><span>                    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TLS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Context</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="tlsCertificateChain"><a href="Network.Stack.Server.html#tlsCertificateChain"><span class="hs-identifier">tlsCertificateChain</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">X509</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">CertificateChain</span><span>
</span><a name="line-118"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-119"></a><span>  </span><a name="local-1912672230"><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier">withServer</span></a></a><span> </span><a name="local-1627460299"><a href="#local-1627460299"><span class="hs-identifier">config</span></a></a><span> </span><a name="local-1627460300"><a href="#local-1627460300"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-120"></a><span>    </span><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier hs-var">withServer</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsTransportConfig</span><span> </span><a href="#local-1627460299"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627460301"><a href="#local-1627460301"><span class="hs-identifier">server</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-121"></a><span>      </span><a href="#local-1627460300"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TlsServer"><span class="hs-identifier hs-var">TlsServer</span></a><span> </span><a href="#local-1627460301"><span class="hs-identifier hs-var">server</span></a><span> </span><a href="#local-1627460299"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>  </span><a name="local-1912672231"><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-1627460302"><a href="#local-1627460302"><span class="hs-identifier">server</span></a></a><span> </span><a name="local-1627460303"><a href="#local-1627460303"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-123"></a><span>    </span><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsTransportServer</span><span> </span><a href="#local-1627460302"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627460304"><a href="#local-1627460304"><span class="hs-identifier">connection</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-124"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627460305"><a href="#local-1627460305"><span class="hs-identifier">backend</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Backend</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-125"></a><span>          </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendFlush</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#flush"><span class="hs-identifier hs-var">flush</span></a><span> </span><a href="#local-1627460304"><span class="hs-identifier hs-var">connection</span></a><span>
</span><a name="line-126"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendClose</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- backend gets closed automatically</span><span>
</span><a name="line-127"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendSend</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#send"><span class="hs-identifier hs-var">send</span></a><span> </span><a href="#local-1627460304"><span class="hs-identifier hs-var">connection</span></a><span>
</span><a name="line-128"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TLS</span><span class="hs-operator">.</span><span class="hs-identifier">backendRecv</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#receive"><span class="hs-identifier hs-var">receive</span></a><span> </span><a href="#local-1627460304"><span class="hs-identifier hs-var">connection</span></a><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-130"></a><span>      </span><a name="local-1627460365"><a href="#local-1627460365"><span class="hs-identifier">mvar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-131"></a><span>      </span><a name="local-1627460423"><a href="#local-1627460423"><span class="hs-identifier">context</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextNew</span><span> </span><a href="#local-1627460305"><span class="hs-identifier hs-var">backend</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsServerParams</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tlsServerConfig</span><span> </span><a href="#local-1627460302"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>      </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextHookSetCertificateRecv</span><span> </span><a href="#local-1627460423"><span class="hs-identifier hs-var">context</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-1627460365"><span class="hs-identifier hs-var">mvar</span></a><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>      </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">handshake</span><span> </span><a href="#local-1627460423"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-134"></a><span>      </span><a name="local-1627460436"><a href="#local-1627460436"><span class="hs-identifier">certificateChain</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryTakeMVar</span><span> </span><a href="#local-1627460365"><span class="hs-identifier hs-var">mvar</span></a><span>
</span><a name="line-135"></a><span>      </span><a name="local-1627460437"><a href="#local-1627460437"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627460303"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TlsServerConnection"><span class="hs-identifier hs-var">TlsServerConnection</span></a><span> </span><a href="#local-1627460304"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-1627460423"><span class="hs-identifier hs-var">context</span></a><span> </span><a href="#local-1627460436"><span class="hs-identifier hs-var">certificateChain</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>      </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">bye</span><span> </span><a href="#local-1627460423"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-137"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-1627460437"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-138"></a><span>  </span><a name="local-1912672232"><a href="Network.Stack.Server.html#flush"><span class="hs-identifier">flush</span></a></a><span> </span><a name="local-1627460469"><a href="#local-1627460469"><span class="hs-identifier">conn</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">contextFlush</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsContext</span><span> </span><a href="#local-1627460469"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>  </span><a name="local-1912672233"><a href="Network.Stack.Server.html#send"><span class="hs-identifier">send</span></a></a><span> </span><a name="local-1627460682"><a href="#local-1627460682"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-1627460683"><a href="#local-1627460683"><span class="hs-identifier">bs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendData</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier">tlsContext</span><span> </span><a href="#local-1627460682"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromStrict</span><span> </span><a href="#local-1627460683"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>  </span><a name="local-1912672234"><a href="Network.Stack.Server.html#receive"><span class="hs-identifier">receive</span></a></a><span> </span><a name="local-1627460684"><a href="#local-1627460684"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TLS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">recvData</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier">tlsContext</span><span> </span><a href="#local-1627460684"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="Network.Stack.Server.html#ServerMessage"><span class="hs-identifier hs-type">ServerMessage</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.Stack.Server.html#ServerStack"><span class="hs-identifier hs-type">ServerStack</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-143"></a><span>  </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">ServerMessage</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-144"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Server</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServer"><a href="Network.Stack.Server.html#WebSocketServer"><span class="hs-identifier">WebSocketServer</span></a></a><span>
</span><a name="line-145"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wsTransportServer"><a href="Network.Stack.Server.html#wsTransportServer"><span class="hs-identifier">wsTransportServer</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-146"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-147"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConfig</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServerConfig"><a href="Network.Stack.Server.html#WebSocketServerConfig"><span class="hs-identifier">WebSocketServerConfig</span></a></a><span>
</span><a name="line-148"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wsTransportConfig"><a href="Network.Stack.Server.html#wsTransportConfig"><span class="hs-identifier">wsTransportConfig</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-149"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-150"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerException</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServerException"><a href="Network.Stack.Server.html#WebSocketServerException"><span class="hs-identifier">WebSocketServerException</span></a></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">ServerConnection</span><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="WebSocketServerConnection"><a href="Network.Stack.Server.html#WebSocketServerConnection"><span class="hs-identifier">WebSocketServerConnection</span></a></a><span>
</span><a name="line-152"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="wsTransportConnection"><a href="Network.Stack.Server.html#wsTransportConnection"><span class="hs-identifier">wsTransportConnection</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627460238"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-153"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="wsPendingConnection"><a href="Network.Stack.Server.html#wsPendingConnection"><span class="hs-identifier">wsPendingConnection</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">PendingConnection</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="wsConnection"><a href="Network.Stack.Server.html#wsConnection"><span class="hs-identifier">wsConnection</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Connection</span><span>
</span><a name="line-155"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-156"></a><span>  </span><a name="local-1912672230"><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier">withServer</span></a></a><span> </span><a name="local-1627460239"><a href="#local-1627460239"><span class="hs-identifier">config</span></a></a><span> </span><a name="local-1627460240"><a href="#local-1627460240"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-157"></a><span>    </span><a href="Network.Stack.Server.html#withServer"><span class="hs-identifier hs-var">withServer</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsTransportConfig</span><span> </span><a href="#local-1627460239"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627460241"><a href="#local-1627460241"><span class="hs-identifier">server</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-158"></a><span>      </span><a href="#local-1627460240"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocketServer"><span class="hs-identifier hs-var">WebSocketServer</span></a><span> </span><a href="#local-1627460241"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>  </span><a name="local-1912672231"><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier">withConnection</span></a></a><span> </span><a name="local-1627460242"><a href="#local-1627460242"><span class="hs-identifier">server</span></a></a><span> </span><a name="local-1627460243"><a href="#local-1627460243"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-160"></a><span>    </span><a href="Network.Stack.Server.html#withConnection"><span class="hs-identifier hs-var">withConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsTransportServer</span><span> </span><a href="#local-1627460242"><span class="hs-identifier hs-var">server</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627460244"><a href="#local-1627460244"><span class="hs-identifier">connection</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-161"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627460245"><a href="#local-1627460245"><span class="hs-identifier">readSocket</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627460246"><a href="#local-1627460246"><span class="hs-identifier">bs</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">BS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-1627460246"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627460246"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Network.Stack.Server.html#receive"><span class="hs-identifier hs-var">receive</span></a><span> </span><a href="#local-1627460244"><span class="hs-identifier hs-var">connection</span></a><span> </span><span class="hs-number">4096</span><span>
</span><a name="line-162"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627460247"><a href="#local-1627460247"><span class="hs-identifier">writeSocket</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">undefined</span><span>
</span><a name="line-163"></a><span>          </span><span class="hs-identifier">writeSocket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627460248"><a href="#local-1627460248"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#send"><span class="hs-identifier hs-var">send</span></a><span> </span><a href="#local-1627460244"><span class="hs-identifier hs-var">connection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toStrict</span><span> </span><a href="#local-1627460248"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>      </span><a name="local-1627460249"><a href="#local-1627460249"><span class="hs-identifier">stream</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">makeStream</span><span> </span><a href="#local-1627460245"><span class="hs-identifier hs-var">readSocket</span></a><span> </span><a href="#local-1627460247"><span class="hs-identifier hs-var">writeSocket</span></a><span>
</span><a name="line-165"></a><span>      </span><a name="local-1627460292"><a href="#local-1627460292"><span class="hs-identifier">pendingConnection</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">makePendingConnectionFromStream</span><span> </span><a href="#local-1627460249"><span class="hs-identifier hs-var">stream</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ConnectionOptions</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>      </span><a name="local-1627460293"><a href="#local-1627460293"><span class="hs-identifier">acceptedConnection</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">acceptRequest</span><span> </span><a href="#local-1627460292"><span class="hs-identifier hs-var">pendingConnection</span></a><span>
</span><a name="line-167"></a><span>      </span><a name="local-1627460294"><a href="#local-1627460294"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-1627460243"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Stack.Server.html#WebSocketServerConnection"><span class="hs-identifier hs-var">WebSocketServerConnection</span></a><span> </span><a href="#local-1627460244"><span class="hs-identifier hs-var">connection</span></a><span> </span><a href="#local-1627460292"><span class="hs-identifier hs-var">pendingConnection</span></a><span> </span><a href="#local-1627460293"><span class="hs-identifier hs-var">acceptedConnection</span></a><span>
</span><a name="line-168"></a><span>      </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendClose</span><span> </span><a href="#local-1627460293"><span class="hs-identifier hs-var">acceptedConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Thank you for flying Haskell.&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-1627460294"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-170"></a><span>  </span><a name="local-1912672232"><a href="Network.Stack.Server.html#flush"><span class="hs-identifier">flush</span></a></a><span> </span><a name="local-1627460295"><a href="#local-1627460295"><span class="hs-identifier">conn</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Network.Stack.Server.html#flush"><span class="hs-identifier hs-var">flush</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsTransportConnection</span><span> </span><a href="#local-1627460295"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>  </span><a name="local-1912672233"><a href="Network.Stack.Server.html#send"><span class="hs-identifier">send</span></a></a><span> </span><a name="local-1627460296"><a href="#local-1627460296"><span class="hs-identifier">conn</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">sendBinaryData</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsConnection</span><span> </span><a href="#local-1627460296"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>  </span><a name="local-1912672234"><a href="Network.Stack.Server.html#receive"><span class="hs-identifier">receive</span></a></a><span> </span><a name="local-1627460297"><a href="#local-1627460297"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">receiveData</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsConnection</span><span> </span><a href="#local-1627460297"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-keyword">instance</span><span> </span><a href="Network.MQTT.Authentication.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">S</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Socket</span><span> </span><a href="#local-1627460022"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-1627460023"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627460024"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627460020"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#TLS"><span class="hs-identifier hs-type">TLS</span></a><span> </span><a href="#local-1627460020"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-177"></a><span>  </span><a name="local-1912666213"><a href="Network.MQTT.Authentication.html#requestSecure"><span class="hs-identifier">requestSecure</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-178"></a><span>  </span><a name="local-1912666217"><a href="Network.MQTT.Authentication.html#requestCertificateChain"><span class="hs-identifier">requestCertificateChain</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tlsCertificateChain</span><span>
</span><a name="line-179"></a><span>  </span><a name="local-1912666216"><a href="Network.MQTT.Authentication.html#requestHeaders"><span class="hs-identifier">requestHeaders</span></a></a><span> </span><a name="local-1627460021"><a href="#local-1627460021"><span class="hs-identifier">a</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.Authentication.html#requestHeaders"><span class="hs-identifier hs-var">requestHeaders</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tlsTransportConnection</span><span> </span><a href="#local-1627460021"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><a href="#local-1627459599"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#ServerConnection"><span class="hs-identifier hs-type">ServerConnection</span></a><span> </span><span class="hs-special">(</span><a href="Network.Stack.Server.html#WebSocket"><span class="hs-identifier hs-type">WebSocket</span></a><span> </span><a href="#local-1627459599"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-182"></a><span>  </span><a name="local-1912666213"><a href="Network.MQTT.Authentication.html#requestSecure"><span class="hs-identifier">requestSecure</span></a></a><span> </span><a name="local-1627459600"><a href="#local-1627459600"><span class="hs-identifier">conn</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.Authentication.html#requestSecure"><span class="hs-identifier hs-var">requestSecure</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsTransportConnection</span><span> </span><a href="#local-1627459600"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>  </span><a name="local-1912666217"><a href="Network.MQTT.Authentication.html#requestCertificateChain"><span class="hs-identifier">requestCertificateChain</span></a></a><span> </span><a name="local-1627459601"><a href="#local-1627459601"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.Authentication.html#requestCertificateChain"><span class="hs-identifier hs-var">requestCertificateChain</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsTransportConnection</span><span> </span><a href="#local-1627459601"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>  </span><a name="local-1912666216"><a href="Network.MQTT.Authentication.html#requestHeaders"><span class="hs-identifier">requestHeaders</span></a></a><span> </span><a name="local-1627459602"><a href="#local-1627459602"><span class="hs-identifier">conn</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WS</span><span class="hs-operator">.</span><span class="hs-identifier">requestHeaders</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">WS</span><span class="hs-operator">.</span><span class="hs-identifier">pendingRequest</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wsPendingConnection</span><span> </span><a href="#local-1627459602"><span class="hs-identifier hs-var">conn</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a></pre></body></html>