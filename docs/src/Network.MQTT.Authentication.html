<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies      #-}</span><span>
</span><a name="line-4"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Module      :  Network.MQTT.Authentication</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- Copyright   :  (c) Lars Petersen 2016</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- License     :  MIT</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Maintainer  :  info@lars-petersen.net</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-12"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Authentication</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span>      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">CaseInsensitive</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">X509</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">X509</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.Message.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Message</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.Topic.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Topic</span></a><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Topic</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-comment">-- | A peer identity optionally associated with connection/session</span><span>
</span><a name="line-25"></a><span class="hs-comment">--   specific information.</span><span>
</span><a name="line-26"></a><span class="hs-comment">--newtype Principal = Principal T.Text deriving (Eq, Ord, Show)</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-comment">-- | An `Authenticator` is able to determine a `Principal`'s identity from a</span><span>
</span><a name="line-29"></a><span class="hs-comment">--   `Request`.</span><span>
</span><a name="line-30"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#AuthenticationException"><span class="hs-identifier hs-type">AuthenticationException</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="Authenticator"><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier">Authenticator</span></a></a><span> </span><a name="local-1627448947"><a href="#local-1627448947"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-31"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">Principal</span><span> </span><a name="local-1627448947"><a href="#local-1627448947"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">AuthenticatorConfig</span><span> </span><a name="local-1627448947"><a href="#local-1627448947"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-comment">-- | This `Exception` may be thrown by any operation within this class.</span><span>
</span><a name="line-34"></a><span>  </span><span class="hs-comment">--   Operations /must/ only throw this type of exception. Other exceptions</span><span>
</span><a name="line-35"></a><span>  </span><span class="hs-comment">--   won't be catched and may kill the broker.</span><span>
</span><a name="line-36"></a><span>  </span><span class="hs-keyword">data</span><span> </span><span class="hs-identifier">AuthenticationException</span><span> </span><a name="local-1627448947"><a href="#local-1627448947"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-comment">-- | Try to determine a `Principal`'s identity from connection `Request`.</span><span>
</span><a name="line-38"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-comment">--   The operation shall return `Nothing` in case the authentication</span><span>
</span><a name="line-40"></a><span>  </span><span class="hs-comment">--   mechanism is working, but couldn't associate an identity. It shall</span><span>
</span><a name="line-41"></a><span>  </span><span class="hs-comment">--   throw and `AuthenticationException` in case of other problems.</span><span>
</span><a name="line-42"></a><span>  </span><span class="hs-identifier">newAuthenticator</span><span>       </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Authentication.html#AuthenticatorConfig"><span class="hs-identifier hs-type">AuthenticatorConfig</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-identifier">authenticate</span><span>           </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#ConnectionRequest"><span class="hs-identifier hs-type">ConnectionRequest</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>  </span><span class="hs-identifier">hasPublishPermission</span><span>   </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Topic.html#Topic"><span class="hs-identifier hs-type">Topic</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Topic</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-identifier">hasSubscribePermission</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627448947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Topic.html#Filter"><span class="hs-identifier hs-type">Topic</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Filter</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- | This class defines how the information gathered from a</span><span>
</span><a name="line-48"></a><span class="hs-comment">--   connection request looks like. An `Authenticator` may use</span><span>
</span><a name="line-49"></a><span class="hs-comment">--   whatever information it finds suitable to authenticate the `Principal`.</span><span>
</span><a name="line-50"></a><span class="hs-keyword">data</span><span> </span><a name="ConnectionRequest"><a href="Network.MQTT.Authentication.html#ConnectionRequest"><span class="hs-identifier">ConnectionRequest</span></a></a><span>
</span><a name="line-51"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="ConnectionRequest"><a href="Network.MQTT.Authentication.html#ConnectionRequest"><span class="hs-identifier">ConnectionRequest</span></a></a><span>
</span><a name="line-52"></a><span>   </span><span class="hs-special">{</span><span> </span><a name="requestClientIdentifier"><a href="Network.MQTT.Authentication.html#requestClientIdentifier"><span class="hs-identifier">requestClientIdentifier</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>     </span><a name="requestCleanSession"><a href="Network.MQTT.Authentication.html#requestCleanSession"><span class="hs-identifier">requestCleanSession</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>     </span><span class="hs-comment">-- | Is this connection secure in terms of</span><span>
</span><a name="line-55"></a><span>     </span><span class="hs-comment">--  [Transport Layer Security](https://en.wikipedia.org/wiki/Transport_Layer_Security)?</span><span>
</span><a name="line-56"></a><span>     </span><a name="requestSecure"><a href="Network.MQTT.Authentication.html#requestSecure"><span class="hs-identifier">requestSecure</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>     </span><span class="hs-comment">-- | The username and password supplied with the MQTT handshake.</span><span>
</span><a name="line-58"></a><span>     </span><a name="requestCredentials"><a href="Network.MQTT.Authentication.html#requestCredentials"><span class="hs-identifier">requestCredentials</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Message.html#Username"><span class="hs-identifier hs-type">Username</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Network.MQTT.Message.html#Password"><span class="hs-identifier hs-type">Password</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>     </span><span class="hs-comment">-- | The HTTP request head in case the client connected via</span><span>
</span><a name="line-60"></a><span>     </span><span class="hs-comment">--   [WebSocket](https://en.wikipedia.org/wiki/WebSocket).</span><span>
</span><a name="line-61"></a><span>     </span><a name="requestHttp"><a href="Network.MQTT.Authentication.html#requestHttp"><span class="hs-identifier">requestHttp</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">CI</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>     </span><span class="hs-comment">-- | An [X.509 certificate](https://en.wikipedia.org/wiki/X.509) chain</span><span>
</span><a name="line-63"></a><span>     </span><span class="hs-comment">--   supplied by the peer.</span><span>
</span><a name="line-64"></a><span>     </span><span class="hs-comment">--   It can be assumed that the transport layer implementation already</span><span>
</span><a name="line-65"></a><span>     </span><span class="hs-comment">--   verified that the peer owns the corresponding private key. The validation</span><span>
</span><a name="line-66"></a><span>     </span><span class="hs-comment">--   of the certificate claims (including certificate chain checking) /must/</span><span>
</span><a name="line-67"></a><span>     </span><span class="hs-comment">--   be performed by the `Authenticator`.</span><span>
</span><a name="line-68"></a><span>     </span><a name="requestCertificateChain"><a href="Network.MQTT.Authentication.html#requestCertificateChain"><span class="hs-identifier">requestCertificateChain</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">X509</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">CertificateChain</span><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>     </span><a name="requestRemoteAddress"><a href="Network.MQTT.Authentication.html#requestRemoteAddress"><span class="hs-identifier">requestRemoteAddress</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">BS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-70"></a><span>   </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a></pre></body></html>