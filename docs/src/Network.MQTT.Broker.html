<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Module      :  Network.MQTT.Broker</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Copyright   :  (c) Lars Petersen 2016</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- License     :  MIT</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Maintainer  :  info@lars-petersen.net</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-10"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Broker</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">BoundedChan</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span class="hs-operator">.</span><span class="hs-identifier">Identity</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntMap</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntSet</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Network.MQTT.RoutingTree.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">RoutingTree</span></a><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">R</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.Topic.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Topic</span></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">type</span><span> </span><a name="SessionKey"><a href="Network.MQTT.Broker.html#SessionKey"><span class="hs-identifier">SessionKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-22"></a><span class="hs-keyword">type</span><span> </span><a name="Message"><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier">Message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">data</span><span> </span><a name="Broker"><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier">Broker</span></a></a><span> </span><a name="local-1627451551"><a href="#local-1627451551"><span class="hs-identifier">authenticator</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Broker"><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier">Broker</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-25"></a><span>    </span><a name="brokerAuthenticator"><a href="Network.MQTT.Broker.html#brokerAuthenticator"><span class="hs-identifier">brokerAuthenticator</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627451551"><span class="hs-identifier hs-type">authenticator</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="brokerState"><a href="Network.MQTT.Broker.html#brokerState"><span class="hs-identifier">brokerState</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-type">BrokerState</span></a><span> </span><a href="#local-1627451551"><span class="hs-identifier hs-type">authenticator</span></a><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">data</span><span> </span><a name="Session"><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier">Session</span></a></a><span> </span><a name="local-1627451550"><a href="#local-1627451550"><span class="hs-identifier">authenticator</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Session"><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier">Session</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-30"></a><span>    </span><a name="sessionBroker"><a href="Network.MQTT.Broker.html#sessionBroker"><span class="hs-identifier">sessionBroker</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627451550"><span class="hs-identifier hs-type">authenticator</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="sessionState"><a href="Network.MQTT.Broker.html#sessionState"><span class="hs-identifier">sessionState</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Network.MQTT.Broker.html#SessionState"><span class="hs-identifier hs-type">SessionState</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">data</span><span> </span><a name="QosLevel"><a href="Network.MQTT.Broker.html#QosLevel"><span class="hs-identifier">QosLevel</span></a></a><span>
</span><a name="line-35"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="Qos0"><a href="Network.MQTT.Broker.html#Qos0"><span class="hs-identifier">Qos0</span></a></a><span>
</span><a name="line-36"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="Qos1"><a href="Network.MQTT.Broker.html#Qos1"><span class="hs-identifier">Qos1</span></a></a><span>
</span><a name="line-37"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="Qos2"><a href="Network.MQTT.Broker.html#Qos2"><span class="hs-identifier">Qos2</span></a></a><span>
</span><a name="line-38"></a><span>   </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">data</span><span> </span><a name="BrokerState"><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier">BrokerState</span></a></a><span> </span><a name="local-1627451549"><a href="#local-1627451549"><span class="hs-identifier">authenticator</span></a></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a name="BrokerState"><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier">BrokerState</span></a></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="brokerMaxSessionKey"><a href="Network.MQTT.Broker.html#brokerMaxSessionKey"><span class="hs-identifier">brokerMaxSessionKey</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Network.MQTT.Broker.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="brokerSubscriptions"><a href="Network.MQTT.Broker.html#brokerSubscriptions"><span class="hs-identifier">brokerSubscriptions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.MQTT.RoutingTree.html#RoutingTree"><span class="hs-identifier hs-type">R</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">RoutingTree</span></a><span> </span><span class="hs-identifier hs-type">IS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="brokerSessions"><a href="Network.MQTT.Broker.html#brokerSessions"><span class="hs-identifier">brokerSessions</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IM</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627451549"><span class="hs-identifier hs-type">authenticator</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-keyword">data</span><span> </span><a name="SessionState"><a href="Network.MQTT.Broker.html#SessionState"><span class="hs-identifier">SessionState</span></a></a><span>
</span><a name="line-48"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a name="SessionState"><a href="Network.MQTT.Broker.html#SessionState"><span class="hs-identifier">SessionState</span></a></a><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="sessionKey"><a href="Network.MQTT.Broker.html#sessionKey"><span class="hs-identifier">sessionKey</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Network.MQTT.Broker.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionTermination"><a href="Network.MQTT.Broker.html#sessionTermination"><span class="hs-identifier">sessionTermination</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionSubscriptions"><a href="Network.MQTT.Broker.html#sessionSubscriptions"><span class="hs-identifier">sessionSubscriptions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.MQTT.RoutingTree.html#RoutingTree"><span class="hs-identifier hs-type">R</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">RoutingTree</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Identity</span><span> </span><a href="Network.MQTT.Broker.html#QosLevel"><span class="hs-identifier hs-type">QosLevel</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionQueue0"><a href="Network.MQTT.Broker.html#sessionQueue0"><span class="hs-identifier">sessionQueue0</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">BoundedChan</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Topic.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionQueue1"><a href="Network.MQTT.Broker.html#sessionQueue1"><span class="hs-identifier">sessionQueue1</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">BoundedChan</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Topic.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionQueue2"><a href="Network.MQTT.Broker.html#sessionQueue2"><span class="hs-identifier">sessionQueue2</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">BoundedChan</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Topic.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier">new</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627451552"><span class="hs-identifier hs-type">authenticator</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627451552"><span class="hs-identifier hs-type">authenticator</span></a><span class="hs-special">)</span><span>
</span><a name="line-58"></a><a name="new"><a href="Network.MQTT.Broker.html#new"><span class="hs-identifier">new</span></a></a><span> </span><a name="local-1627451553"><a href="#local-1627451553"><span class="hs-identifier">authenticator</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-59"></a><span>  </span><a name="local-1627451554"><a href="#local-1627451554"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-var">BrokerState</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerMaxSessionKey</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSessions</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-64"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-var">Broker</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-65"></a><span>      </span><span class="hs-identifier">brokerAuthenticator</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627451553"><span class="hs-identifier hs-var">authenticator</span></a><span>
</span><a name="line-66"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerState</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627451554"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-67"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-keyword">data</span><span> </span><a name="SessionConfig"><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier">SessionConfig</span></a></a><span>
</span><a name="line-70"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="SessionConfig"><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier">SessionConfig</span></a></a><span>
</span><a name="line-71"></a><span>     </span><span class="hs-special">{</span><span> </span><a name="sessionConfigQueue0MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue0MaxSize"><span class="hs-identifier">sessionConfigQueue0MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-72"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="sessionConfigQueue1MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue1MaxSize"><span class="hs-identifier">sessionConfigQueue1MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-73"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="sessionConfigQueue2MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue2MaxSize"><span class="hs-identifier">sessionConfigQueue2MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-74"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-comment">{-

createSession :: Broker -&gt; SessionConfig -&gt; IO Session
createSession (Broker broker) config =
  modifyMVar broker $ \brokerState-&gt; do
    term   &lt;- newEmptyMVar
    queue0 &lt;- newBoundedChan (sessionConfigQueue0MaxSize config)
    queue1 &lt;- newBoundedChan (sessionConfigQueue1MaxSize config)
    queue2 &lt;- newBoundedChan (sessionConfigQueue2MaxSize config)
    let newSessionKey    = brokerMaxSessionKey brokerState + 1
    newSession &lt;- Session &lt;$&gt; newMVar SessionState
         { sessionBroker           = Broker broker
         , sessionKey              = newSessionKey
         , sessionTermination      = term
         , sessionSubscriptions    = R.empty
         , sessionQueue0           = queue0
         , sessionQueue1           = queue1
         , sessionQueue2           = queue2
         }
    let newBrokerState = brokerState
         { brokerMaxSessionKey  = newSessionKey
         , brokerSessions       = IM.insert newSessionKey newSession (brokerSessions brokerState)
         }
    pure (newBrokerState, newSession)

closeSession :: Session -&gt; IO ()
closeSession (Session session) =
  withMVar session $ \sessionState-&gt;
    modifyMVar_ (unBroker $ sessionBroker sessionState) $ \brokerState-&gt;
      --tryPutMVar (sessionTermination sst) ()
      pure $ brokerState
        { brokerSubscriptions =
            R.differenceWith IS.difference
              ( brokerSubscriptions brokerState)
              ( R.map ( const $ IS.singleton $ sessionKey sessionState )
                      ( sessionSubscriptions sessionState ) )
        , brokerSessions =
            IM.delete
              ( sessionKey sessionState )
              ( brokerSessions brokerState)
        }

subscribeSession :: Session -&gt; [(TopicFilter, QosLevel)] -&gt; IO ()
subscribeSession (Session session) filters =
  modifyMVar_ session $ \sessionState-&gt;
    modifyMVar (unBroker $ sessionBroker sessionState) $ \brokerState-&gt; do
      let newSessionState = sessionState
           { sessionSubscriptions = foldr
              (\(f,q)-&gt; R.insertWith max f (Identity q))
              (sessionSubscriptions sessionState) filters
           }
      let newBrokerState = brokerState
           { brokerSubscriptions = foldr
              (\(x,_)-&gt; R.insertWith IS.union x (IS.singleton $ sessionKey sessionState))
              (brokerSubscriptions brokerState) filters
           }
      pure (newBrokerState, newSessionState)

unsubscribeSession :: Session -&gt; [TopicFilter] -&gt; IO ()
unsubscribeSession (Session session) filters =
  modifyMVar_ session $ \sessionState-&gt;
    modifyMVar (unBroker $ sessionBroker sessionState) $ \brokerState-&gt; do
      let newSessionState = sessionState
           { sessionSubscriptions = foldr R.delete (sessionSubscriptions sessionState) filters
           }
      let newBrokerState = brokerState
           { brokerSubscriptions = foldr
              (R.adjust (IS.delete $ sessionKey sessionState))
              (brokerSubscriptions brokerState) filters
           }
      pure (newBrokerState, newSessionState)

-- FIXME: What about downgrading message qos?
deliverSession :: Session -&gt; Topic -&gt; Message -&gt; IO ()
deliverSession session topic message = do
  sst &lt;- readMVar (unSession session)
  case R.lookupWith max topic (sessionSubscriptions sst) of
    Just (Identity Qos0) -&gt; do
      success &lt;- tryWriteChan (sessionQueue0 sst) (topic, message)
      unless success (closeSession session)
    Just (Identity Qos1) -&gt; do
      success &lt;- tryWriteChan (sessionQueue1 sst) (topic, message)
      unless success (closeSession session)
    Just (Identity Qos2) -&gt; do
      success &lt;- tryWriteChan (sessionQueue2 sst) (topic, message)
      unless success (closeSession session)
    _ -&gt; pure ()

publishBroker :: Broker -&gt; Topic -&gt; Message -&gt; IO ()
publishBroker (Broker broker) topic message = do
  brokerState &lt;- readMVar broker
  forM_ (IS.elems $ fromMaybe IS.empty $ R.lookupWith IS.union topic $ brokerSubscriptions brokerState) $ \key-&gt;
    case IM.lookup (key :: Int) (brokerSessions brokerState) of
      Nothing      -&gt; pure ()
      Just session -&gt; deliverSession session topic message
-}</span><span>
</span><a name="line-172"></a><span class="hs-comment">{-
type  SessionKey = Int

data  MqttBrokerSessions
   =  MqttBrokerSessions
      { maxSession    :: SessionKey
      , subscriptions :: SubscriptionTree
      , session       :: IM.IntMap MqttBrokerSession
      }


data  MqttBrokerSession
    = MqttBrokerSession
      { sessionBroker                  :: MqttBroker
      , sessionConnection              :: MVar (Async ())
      , sessionOutputBuffer            :: MVar RawMessage
      , sessionBestEffortQueue         :: BC.BoundedChan Message
      , sessionGuaranteedDeliveryQueue :: BC.BoundedChan Message
      , sessionInboundPacketState      :: MVar (IM.IntMap InboundPacketState)
      , sessionOutboundPacketState     :: MVar (IM.IntMap OutboundPacketState)
      , sessionSubscriptions           :: IS.Set TopicTopicFilter
      }

data  Identity
data  InboundPacketState

data  OutboundPacketState
   =  NotAcknowledgedPublishQoS1 Message
   |  NotReceivedPublishQoS2     Message
   |  NotCompletePublishQoS2     Message

data MConnection
   = MConnection
     { msend    :: Message -&gt; IO ()
     , mreceive :: IO Message
     , mclose   :: IO ()
     }

publish :: MqttBrokerSession -&gt; Message -&gt; IO ()
publish session message = case qos message of
  -- For QoS0 messages, the queue will simply overflow and messages will get
  -- lost. This is the desired behaviour and allowed by contract.
  QoS0 -&gt;
    void $ BC.writeChan (sessionBestEffortQueue session) message
  -- For QoS1 and QoS2 messages, an overflow will kill the connection and
  -- delete the session. We cannot otherwise signal the client that we are
  -- unable to further serve the contract.
  _ -&gt; do
    success &lt;- BC.tryWriteChan (sessionGuaranteedDeliveryQueue session) message
    unless success undefined -- sessionTerminate session

dispatchConnection :: MqttBroker -&gt; Connection -&gt; IO ()
dispatchConnection broker connection =
  withConnect $ \clientIdentifier cleanSession keepAlive mwill muser j-&gt; do
    -- Client sent a valid CONNECT packet. Next, authenticate the client.
    midentity &lt;- brokerAuthenticate broker muser
    case midentity of
      -- Client authentication failed. Send CONNACK with `NotAuthorized`.
      Nothing -&gt; send $ ConnectAcknowledgement $ Left NotAuthorized
      -- Cient authenticaion successfull.
      Just identity -&gt; do
        -- Retrieve session; create new one if necessary.
        (session, sessionPresent) &lt;- getSession broker clientIdentifier
        -- Now knowing the session state, we can send the success CONNACK.
        send $ ConnectAcknowledgement $ Right sessionPresent
        -- Replace (and shutdown) existing connections.
        modifyMVar_ (sessionConnection session) $ \previousConnection-&gt; do
          cancel previousConnection
          async $ maintainConnection session `finally` close connection
  where
    -- Tries to receive the first packet and (if applicable) extracts the
    -- CONNECT information to call the contination with.
    withConnect :: (ClientIdentifier -&gt; CleanSession -&gt; KeepAlive -&gt; Maybe Will -&gt; Maybe (Username, Maybe Password) -&gt; BS.ByteString -&gt; IO ()) -&gt; IO ()
    withConnect  = undefined

    send :: RawMessage -&gt; IO ()
    send  = undefined

    maintainConnection :: MqttBrokerSession -&gt; IO ()
    maintainConnection session =
      processKeepAlive `race_` processInput `race_` processOutput
        `race_` processBestEffortQueue `race_` processGuaranteedDeliveryQueue

      where
        processKeepAlive = undefined
        processInput     = undefined
        processOutput    = undefined
        processBestEffortQueue = forever $ do
          message &lt;- BC.readChan (sessionBestEffortQueue session)
          putMVar (sessionOutputBuffer session) Publish
            { publishDuplicate = False
            , publishRetain    = retained message
            , publishQoS       = undefined -- Nothing
            , publishTopic     = topic message
            , publishBody      = payload message
            }
        processGuaranteedDeliveryQueue = undefined

getSession :: MqttBroker -&gt; ClientIdentifier -&gt; IO (MqttBrokerSession, SessionPresent)
getSession broker clientIdentifier =
  modifyMVar (brokerSessions broker) $ \ms-&gt;
    case M.lookup clientIdentifier ms of
      Just session -&gt; pure (ms, (session, True))
      Nothing      -&gt; do
        mthread &lt;- newMVar =&lt;&lt; async (pure ())
        session &lt;- MqttBrokerSession
          &lt;$&gt; pure broker
          &lt;*&gt; pure mthread
          &lt;*&gt; newEmptyMVar
          &lt;*&gt; BC.newBoundedChan 1000
          &lt;*&gt; BC.newBoundedChan 1000
          &lt;*&gt; newEmptyMVar
          &lt;*&gt; newEmptyMVar
        pure (M.insert clientIdentifier session ms, (session, False))
-}</span><span>
</span><a name="line-287"></a></pre></body></html>