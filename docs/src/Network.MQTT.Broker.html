<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TupleSections     #-}</span><span>
</span><a name="line-3"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Module      :  Network.MQTT.Broker</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Copyright   :  (c) Lars Petersen 2016</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- License     :  MIT</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Maintainer  :  info@lars-petersen.net</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-11"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Broker</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span class="hs-operator">.</span><span class="hs-identifier">Identity</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntMap</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntSet</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.Authentication.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Authentication</span></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#AuthenticationException"><span class="hs-identifier hs-type">AuthenticationException</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>                                              </span><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier hs-type">Authenticator</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>                                              </span><a href="Network.MQTT.Authentication.html#ConnectionRequest"><span class="hs-identifier hs-type">ConnectionRequest</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>                                              </span><a href="Network.MQTT.Authentication.html#authenticate"><span class="hs-identifier hs-var">authenticate</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>                                              </span><a href="Network.MQTT.Authentication.html#hasPublishPermission"><span class="hs-identifier hs-var">hasPublishPermission</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>                                              </span><a href="Network.MQTT.Authentication.html#hasSubscribePermission"><span class="hs-identifier hs-var">hasSubscribePermission</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.Message.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Message</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Network.MQTT.RoutingTree.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">RoutingTree</span></a><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">R</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Network.MQTT.Session.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Session</span></a><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Session</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.Topic.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Topic</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Network.MQTT.RetainedMessages.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">RetainedMessages</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">RM</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Log</span><span class="hs-operator">.</span><span class="hs-identifier">Logger</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Log</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">data</span><span> </span><a name="Broker"><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier">Broker</span></a></a><span> </span><a name="local-1627458853"><a href="#local-1627458853"><span class="hs-identifier">auth</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Broker"><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier">Broker</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-36"></a><span>    </span><a name="brokerAuthenticator"><a href="Network.MQTT.Broker.html#brokerAuthenticator"><span class="hs-identifier">brokerAuthenticator</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627458853"><span class="hs-identifier hs-type">auth</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="brokerRetainedMessages"><a href="Network.MQTT.Broker.html#brokerRetainedMessages"><span class="hs-identifier">brokerRetainedMessages</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Network.MQTT.RetainedMessages.html#RetainedTree"><span class="hs-identifier hs-type">RM</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">RetainedTree</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="brokerState"><a href="Network.MQTT.Broker.html#brokerState"><span class="hs-identifier">brokerState</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-type">BrokerState</span></a><span> </span><a href="#local-1627458853"><span class="hs-identifier hs-type">auth</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">data</span><span> </span><a name="BrokerState"><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier">BrokerState</span></a></a><span> </span><a name="local-1627458852"><a href="#local-1627458852"><span class="hs-identifier">auth</span></a></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a name="BrokerState"><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier">BrokerState</span></a></a><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="brokerMaxSessionIdentifier"><a href="Network.MQTT.Broker.html#brokerMaxSessionIdentifier"><span class="hs-identifier">brokerMaxSessionIdentifier</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Network.MQTT.Session.html#Identifier"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Identifier</span></a><span>
</span><a name="line-44"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="brokerSubscriptions"><a href="Network.MQTT.Broker.html#brokerSubscriptions"><span class="hs-identifier">brokerSubscriptions</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.MQTT.RoutingTree.html#RoutingTree"><span class="hs-identifier hs-type">R</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">RoutingTree</span></a><span> </span><span class="hs-identifier hs-type">IS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="brokerSessions"><a href="Network.MQTT.Broker.html#brokerSessions"><span class="hs-identifier">brokerSessions</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IM</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IntMap</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627458852"><span class="hs-identifier hs-type">auth</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="brokerPrincipals"><a href="Network.MQTT.Broker.html#brokerPrincipals"><span class="hs-identifier">brokerPrincipals</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">M</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627458852"><span class="hs-identifier hs-type">auth</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">M</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Network.MQTT.Message.html#ClientIdentifier"><span class="hs-identifier hs-type">ClientIdentifier</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-identifier">new</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier hs-type">Authenticator</span></a><span> </span><a href="#local-1627458862"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-1627458862"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458862"><span class="hs-identifier hs-type">auth</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><a name="new"><a href="Network.MQTT.Broker.html#new"><span class="hs-identifier">new</span></a></a><span> </span><a name="local-1627458863"><a href="#local-1627458863"><span class="hs-identifier">authenticator</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-51"></a><span>  </span><a name="local-1627458864"><a href="#local-1627458864"><span class="hs-identifier">rm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="Network.MQTT.RetainedMessages.html#empty"><span class="hs-identifier hs-var">RM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-52"></a><span>  </span><a name="local-1627458865"><a href="#local-1627458865"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-var">BrokerState</span></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerMaxSessionIdentifier</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSessions</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerPrincipals</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-58"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-var">Broker</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-59"></a><span>      </span><span class="hs-identifier">brokerAuthenticator</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627458863"><span class="hs-identifier hs-var">authenticator</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerRetainedMessages</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627458864"><span class="hs-identifier hs-var">rm</span></a><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerState</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627458865"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-keyword">data</span><span> </span><a name="SessionConfig"><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier">SessionConfig</span></a></a><span>
</span><a name="line-65"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="SessionConfig"><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier">SessionConfig</span></a></a><span>
</span><a name="line-66"></a><span>     </span><span class="hs-special">{</span><span> </span><a name="sessionConfigQueue0MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue0MaxSize"><span class="hs-identifier">sessionConfigQueue0MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-67"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="sessionConfigQueue1MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue1MaxSize"><span class="hs-identifier">sessionConfigQueue1MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-68"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="sessionConfigQueue2MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue2MaxSize"><span class="hs-identifier">sessionConfigQueue2MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-69"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-identifier">defaultSessionConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier hs-type">SessionConfig</span></a><span>
</span><a name="line-72"></a><a name="defaultSessionConfig"><a href="Network.MQTT.Broker.html#defaultSessionConfig"><span class="hs-identifier">defaultSessionConfig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier hs-var">SessionConfig</span></a><span> </span><span class="hs-number">100</span><span> </span><span class="hs-number">100</span><span> </span><span class="hs-number">100</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-identifier">withSession</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier hs-type">Authenticator</span></a><span> </span><a href="#local-1627458861"><span class="hs-identifier hs-type">auth</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458861"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#ConnectionRequest"><span class="hs-identifier hs-type">ConnectionRequest</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Authentication.html#AuthenticationException"><span class="hs-identifier hs-type">AuthenticationException</span></a><span> </span><a href="#local-1627458861"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627458861"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Message.html#SessionPresent"><span class="hs-identifier hs-type">SessionPresent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627458861"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><a name="withSession"><a href="Network.MQTT.Broker.html#withSession"><span class="hs-identifier">withSession</span></a></a><span> </span><a name="local-1627458866"><a href="#local-1627458866"><span class="hs-identifier">broker</span></a></a><span> </span><a name="local-1627458867"><a href="#local-1627458867"><span class="hs-identifier">request</span></a></a><span> </span><a name="local-1627458868"><a href="#local-1627458868"><span class="hs-identifier">sessionRejectHandler</span></a></a><span> </span><a name="local-1627458869"><a href="#local-1627458869"><span class="hs-identifier">sessionErrorHandler</span></a></a><span> </span><a name="local-1627458870"><a href="#local-1627458870"><span class="hs-identifier">sessionHandler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-76"></a><span>  </span><a name="local-1627459196"><a href="#local-1627459196"><span class="hs-identifier">emp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.MQTT.Authentication.html#authenticate"><span class="hs-identifier hs-var">authenticate</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerAuthenticator</span><span> </span><a href="#local-1627458866"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627458867"><span class="hs-identifier hs-var">request</span></a><span>
</span><a name="line-77"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627459196"><span class="hs-identifier hs-var">emp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-78"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-1627459197"><a href="#local-1627459197"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627458869"><span class="hs-identifier hs-var">sessionErrorHandler</span></a><span> </span><a href="#local-1627459197"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-1627459198"><a href="#local-1627459198"><span class="hs-identifier">mp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627459198"><span class="hs-identifier hs-var">mp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-80"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627458868"><span class="hs-identifier hs-var">sessionRejectHandler</span></a><span>
</span><a name="line-81"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627459199"><a href="#local-1627459199"><span class="hs-identifier">principal</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">bracket</span><span>
</span><a name="line-82"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerState</span><span> </span><a href="#local-1627458866"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.MQTT.Broker.html#getSession"><span class="hs-identifier hs-var">getSession</span></a><span> </span><a href="#local-1627459199"><span class="hs-identifier hs-var">principal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">requestClientIdentifier</span><span> </span><a href="#local-1627458867"><span class="hs-identifier hs-var">request</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627459200"><a href="#local-1627459200"><span class="hs-identifier">_present</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627459201"><a href="#local-1627459201"><span class="hs-identifier">session</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">requestCleanSession</span><span> </span><a href="#local-1627458867"><span class="hs-identifier hs-var">request</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#closeSession"><span class="hs-identifier hs-var">closeSession</span></a><span> </span><a href="#local-1627458866"><span class="hs-identifier hs-var">broker</span></a><span> </span><a href="#local-1627459201"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627459202"><a href="#local-1627459202"><span class="hs-identifier">present</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627459203"><a href="#local-1627459203"><span class="hs-identifier">session</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627458870"><span class="hs-identifier hs-var">sessionHandler</span></a><span> </span><a href="#local-1627459203"><span class="hs-identifier hs-var">session</span></a><span> </span><a href="#local-1627459202"><span class="hs-identifier hs-var">present</span></a><span> </span><a href="#local-1627459199"><span class="hs-identifier hs-var">principal</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-identifier">getSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier hs-type">Authenticator</span></a><span> </span><a href="#local-1627458860"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.MQTT.Authentication.html#Principal"><span class="hs-identifier hs-type">Principal</span></a><span> </span><a href="#local-1627458860"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Message.html#ClientIdentifier"><span class="hs-identifier hs-type">ClientIdentifier</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-type">BrokerState</span></a><span> </span><a href="#local-1627458860"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-type">BrokerState</span></a><span> </span><a href="#local-1627458860"><span class="hs-identifier hs-type">auth</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Message.html#SessionPresent"><span class="hs-identifier hs-type">SessionPresent</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627458860"><span class="hs-identifier hs-type">auth</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><a name="getSession"><a href="Network.MQTT.Broker.html#getSession"><span class="hs-identifier">getSession</span></a></a><span> </span><a name="local-1627459204"><a href="#local-1627459204"><span class="hs-identifier">principal</span></a></a><span> </span><a name="local-1627459205"><a href="#local-1627459205"><span class="hs-identifier">cid</span></a></a><span> </span><a name="local-1627459206"><a href="#local-1627459206"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-88"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-1627459204"><span class="hs-identifier hs-var">principal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerPrincipals</span><span> </span><a href="#local-1627459206"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627459215"><a href="#local-1627459215"><span class="hs-identifier">mcis</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-1627459205"><span class="hs-identifier hs-var">cid</span></a><span> </span><a href="#local-1627459215"><span class="hs-identifier hs-var">mcis</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627459216"><a href="#local-1627459216"><span class="hs-identifier">sid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-91"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-1627459216"><span class="hs-identifier hs-var">sid</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerSessions</span><span> </span><a href="#local-1627459206"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-92"></a><span>          </span><span class="hs-comment">-- Resuming an existing session..</span><span>
</span><a name="line-93"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627459217"><a href="#local-1627459217"><span class="hs-identifier">session</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-1627459206"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-1627459217"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>          </span><span class="hs-comment">-- Orphaned session id. This is illegal state.</span><span>
</span><a name="line-95"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-96"></a><span>            </span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">warningM</span><span> </span><span class="hs-string">&quot;Broker.getSession&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Illegal state: Found orphanded session id &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627459216"><span class="hs-identifier hs-var">sid</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-97"></a><span>            </span><a href="#local-1627459207"><span class="hs-identifier hs-var">createSession</span></a><span>
</span><a name="line-98"></a><span>      </span><span class="hs-comment">-- No session found for client identifier. Creating one.</span><span>
</span><a name="line-99"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627459207"><span class="hs-identifier hs-var">createSession</span></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-comment">-- No session entry found for principal. Creating one.</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627459207"><span class="hs-identifier hs-var">createSession</span></a><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-comment">--createSession :: IO (BrokerState auth, Session.Session)</span><span>
</span><a name="line-104"></a><span>    </span><a name="local-1627459207"><a href="#local-1627459207"><span class="hs-identifier">createSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-105"></a><span>      </span><a name="local-1627459208"><a href="#local-1627459208"><span class="hs-identifier">incompleteQos2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-106"></a><span>      </span><a name="local-1627459209"><a href="#local-1627459209"><span class="hs-identifier">subscriptions</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="Network.MQTT.RoutingTree.html#empty"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-107"></a><span>      </span><a name="local-1627459210"><a href="#local-1627459210"><span class="hs-identifier">queue</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Session.html#emptyServerQueue"><span class="hs-identifier hs-var">Session</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">emptyServerQueue</span></a><span> </span><span class="hs-number">1000</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>      </span><a name="local-1627459211"><a href="#local-1627459211"><span class="hs-identifier">queuePending</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-109"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627459212"><a href="#local-1627459212"><span class="hs-identifier">newSessionIdentifier</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">brokerMaxSessionIdentifier</span><span> </span><a href="#local-1627459206"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-110"></a><span>          </span><a name="local-1627459213"><a href="#local-1627459213"><span class="hs-identifier">newSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-var">Session</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Session</span></a><span>
</span><a name="line-111"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionIdentifier</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459212"><span class="hs-identifier hs-var">newSessionIdentifier</span></a><span>
</span><a name="line-112"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionClientIdentifier</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459205"><span class="hs-identifier hs-var">cid</span></a><span>
</span><a name="line-113"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionPrincipal</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459204"><span class="hs-identifier hs-var">principal</span></a><span>
</span><a name="line-114"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionIncompleteQos2</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459208"><span class="hs-identifier hs-var">incompleteQos2</span></a><span>
</span><a name="line-115"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionSubscriptions</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459209"><span class="hs-identifier hs-var">subscriptions</span></a><span>
</span><a name="line-116"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionQueue</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459210"><span class="hs-identifier hs-var">queue</span></a><span>
</span><a name="line-117"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionQueuePending</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459211"><span class="hs-identifier hs-var">queuePending</span></a><span>
</span><a name="line-118"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionQueueLimitQos0</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">256</span><span>
</span><a name="line-119"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-120"></a><span>          </span><a name="local-1627459214"><a href="#local-1627459214"><span class="hs-identifier">newBrokerState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459206"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-121"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerMaxSessionIdentifier</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627459212"><span class="hs-identifier hs-var">newSessionIdentifier</span></a><span>
</span><a name="line-122"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSessions</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-1627459212"><span class="hs-identifier hs-var">newSessionIdentifier</span></a><span> </span><a href="#local-1627459213"><span class="hs-identifier hs-var">newSession</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerSessions</span><span> </span><a href="#local-1627459206"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerPrincipals</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unionWith</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">union</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerPrincipals</span><span> </span><a href="#local-1627459206"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-1627459204"><span class="hs-identifier hs-var">principal</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-1627459205"><span class="hs-identifier hs-var">cid</span></a><span> </span><a href="#local-1627459212"><span class="hs-identifier hs-var">newSessionIdentifier</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-125"></a><span>      </span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">infoM</span><span> </span><span class="hs-string">&quot;Broker.createSession&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Creating new session with id &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627459212"><span class="hs-identifier hs-var">newSessionIdentifier</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627459204"><span class="hs-identifier hs-var">principal</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-126"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-1627459214"><span class="hs-identifier hs-var">newBrokerState</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-1627459213"><span class="hs-identifier hs-var">newSession</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">closeSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier hs-type">Authenticator</span></a><span> </span><a href="#local-1627458859"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458859"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627458859"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><a name="closeSession"><a href="Network.MQTT.Broker.html#closeSession"><span class="hs-identifier">closeSession</span></a></a><span> </span><a name="local-1627459218"><a href="#local-1627459218"><span class="hs-identifier">broker</span></a></a><span> </span><a name="local-1627459219"><a href="#local-1627459219"><span class="hs-identifier">session</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerState</span><span> </span><a href="#local-1627459218"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459220"><a href="#local-1627459220"><span class="hs-identifier">st</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-identifier hs-var">withMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionSubscriptions</span><span> </span><a href="#local-1627459219"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459221"><a href="#local-1627459221"><span class="hs-identifier">subscriptions</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-132"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627459220"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-133"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-134"></a><span>            </span><span class="hs-comment">-- Remove the session identifier from each set that the session subscription</span><span>
</span><a name="line-135"></a><span>            </span><span class="hs-comment">-- tree has a corresponding value for (which is ignored).</span><span>
</span><a name="line-136"></a><span>            </span><a href="Network.MQTT.RoutingTree.html#differenceWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">differenceWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627459222"><a href="#local-1627459222"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionIdentifier</span><span> </span><a href="#local-1627459219"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459222"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627459220"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459221"><span class="hs-identifier hs-var">subscriptions</span></a><span>
</span><a name="line-138"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSessions</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-139"></a><span>            </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span>
</span><a name="line-140"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionIdentifier</span><span> </span><a href="#local-1627459219"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">brokerSessions</span><span> </span><a href="#local-1627459220"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerPrincipals</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-143"></a><span>            </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">update</span><span>
</span><a name="line-144"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627459223"><a href="#local-1627459223"><span class="hs-identifier">mcid</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627459224"><a href="#local-1627459224"><span class="hs-identifier">mcid'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionClientIdentifier</span><span> </span><a href="#local-1627459219"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459223"><span class="hs-identifier hs-var">mcid</span></a><span>
</span><a name="line-145"></a><span>                              </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-1627459224"><span class="hs-identifier hs-var">mcid'</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627459224"><span class="hs-identifier hs-var">mcid'</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionPrincipal</span><span> </span><a href="#local-1627459219"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">brokerPrincipals</span><span> </span><a href="#local-1627459220"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-identifier">publishDownstream</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458858"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Message.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><a name="publishDownstream"><a href="Network.MQTT.Broker.html#publishDownstream"><span class="hs-identifier">publishDownstream</span></a></a><span> </span><a name="local-1627459225"><a href="#local-1627459225"><span class="hs-identifier">broker</span></a></a><span> </span><a name="local-1627459226"><a href="#local-1627459226"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-151"></a><span>  </span><span class="hs-comment">-- Log.debugM &quot;Broker.publishDownstream&quot; $ show msg</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">msgRetain</span><span> </span><a href="#local-1627459226"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">debugM</span><span> </span><span class="hs-string">&quot;Broker.publishDownstream&quot;</span><span> </span><span class="hs-string">&quot;retain&quot;</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerRetainedMessages</span><span> </span><a href="#local-1627459225"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459227"><a href="#local-1627459227"><span class="hs-identifier">rm</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="Network.MQTT.RetainedMessages.html#insert"><span class="hs-identifier hs-var">RM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-1627459226"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-1627459227"><span class="hs-identifier hs-var">rm</span></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627459228"><a href="#local-1627459228"><span class="hs-identifier">topic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">msgTopic</span><span> </span><a href="#local-1627459226"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-157"></a><span>  </span><a name="local-1627459229"><a href="#local-1627459229"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerState</span><span> </span><a href="#local-1627459225"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>  </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">elems</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.MQTT.RoutingTree.html#lookup"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-1627459228"><span class="hs-identifier hs-var">topic</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627459229"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459230"><a href="#local-1627459230"><span class="hs-identifier">key</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-special">(</span><a href="#local-1627459230"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerSessions</span><span> </span><a href="#local-1627459229"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-160"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-string">&quot;WARNING: dead session reference&quot;</span><span>
</span><a name="line-162"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627459365"><a href="#local-1627459365"><span class="hs-identifier">session</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Session.html#enqueueMessage"><span class="hs-identifier hs-var">Session</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">enqueueMessage</span></a><span> </span><a href="#local-1627459365"><span class="hs-identifier hs-var">session</span></a><span> </span><a href="#local-1627459226"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-comment">-- | Publish a message on the broker regarding specific permissions of the session.</span><span>
</span><a name="line-165"></a><span class="hs-comment">--</span><span>
</span><a name="line-166"></a><span class="hs-comment">--   QUESTION: Where do qos 1 and 2 messages get acknowledged?</span><span>
</span><a name="line-167"></a><span class="hs-identifier">publishUpstream</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier hs-type">Authenticator</span></a><span> </span><a href="#local-1627458857"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458857"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627458857"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Message.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><a name="publishUpstream"><a href="Network.MQTT.Broker.html#publishUpstream"><span class="hs-identifier">publishUpstream</span></a></a><span> </span><a name="local-1627459366"><a href="#local-1627459366"><span class="hs-identifier">broker</span></a></a><span> </span><a name="local-1627459367"><a href="#local-1627459367"><span class="hs-identifier">session</span></a></a><span>  </span><a name="local-1627459368"><a href="#local-1627459368"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>  </span><a name="local-1627459369"><a href="#local-1627459369"><span class="hs-identifier">isPermitted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.MQTT.Authentication.html#hasPublishPermission"><span class="hs-identifier hs-var">hasPublishPermission</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerAuthenticator</span><span> </span><a href="#local-1627459366"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionPrincipal</span><span> </span><a href="#local-1627459367"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">msgTopic</span><span> </span><a href="#local-1627459368"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">debugM</span><span> </span><span class="hs-string">&quot;Broker.publishUpstream&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionPrincipal</span><span> </span><a href="#local-1627459367"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; publishes on &quot;</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">msgTopic</span><span> </span><a href="#local-1627459368"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-1627459369"><span class="hs-identifier hs-var">isPermitted</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;OK&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;FORBIDDEN&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627459369"><span class="hs-identifier hs-var">isPermitted</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="Network.MQTT.Broker.html#publishDownstream"><span class="hs-identifier hs-var">publishDownstream</span></a><span> </span><a href="#local-1627459366"><span class="hs-identifier hs-var">broker</span></a><span> </span><a href="#local-1627459368"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-identifier">publishUpstream'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458856"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Message.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><a name="publishUpstream%27"><a href="Network.MQTT.Broker.html#publishUpstream%27"><span class="hs-identifier">publishUpstream'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.Broker.html#publishDownstream"><span class="hs-identifier hs-var">publishDownstream</span></a><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-identifier">subscribe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Authentication.html#Authenticator"><span class="hs-identifier hs-type">Authenticator</span></a><span> </span><a href="#local-1627458855"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458855"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627458855"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Message.html#PacketIdentifier"><span class="hs-identifier hs-type">PacketIdentifier</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Network.MQTT.Topic.html#Filter"><span class="hs-identifier hs-type">Filter</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Message.html#QualityOfService"><span class="hs-identifier hs-type">QualityOfService</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><a name="subscribe"><a href="Network.MQTT.Broker.html#subscribe"><span class="hs-identifier">subscribe</span></a></a><span> </span><a name="local-1627459370"><a href="#local-1627459370"><span class="hs-identifier">broker</span></a></a><span> </span><a name="local-1627459371"><a href="#local-1627459371"><span class="hs-identifier">session</span></a></a><span> </span><a name="local-1627459372"><a href="#local-1627459372"><span class="hs-identifier">pid</span></a></a><span> </span><a name="local-1627459373"><a href="#local-1627459373"><span class="hs-identifier">filters</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-181"></a><span>  </span><a name="local-1627459849"><a href="#local-1627459849"><span class="hs-identifier">checkedFilters</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-1627459374"><span class="hs-identifier hs-var">checkPermission</span></a><span> </span><a href="#local-1627459373"><span class="hs-identifier hs-var">filters</span></a><span>
</span><a name="line-182"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627459850"><a href="#local-1627459850"><span class="hs-identifier">subscribeFilters</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627459853"><a href="#local-1627459853"><span class="hs-identifier">filtr</span></a></a><span class="hs-special">,</span><a name="local-1627459854"><a href="#local-1627459854"><span class="hs-identifier">mqos</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-1627459853"><span class="hs-identifier hs-var">filtr</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Identity</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-1627459854"><span class="hs-identifier hs-var">mqos</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459849"><span class="hs-identifier hs-var">checkedFilters</span></a><span>
</span><a name="line-183"></a><span>      </span><a name="local-1627459851"><a href="#local-1627459851"><span class="hs-identifier">qosTree</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.RoutingTree.html#insertFoldable"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insertFoldable</span></a><span> </span><a href="#local-1627459850"><span class="hs-identifier hs-var">subscribeFilters</span></a><span> </span><a href="Network.MQTT.RoutingTree.html#empty"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-184"></a><span>      </span><a name="local-1627459852"><a href="#local-1627459852"><span class="hs-identifier">sidTree</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.RoutingTree.html#map"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionIdentifier</span><span> </span><a href="#local-1627459371"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459851"><span class="hs-identifier hs-var">qosTree</span></a><span>
</span><a name="line-185"></a><span>  </span><span class="hs-comment">-- Force the `qosTree` in order to lock the broker as little as possible.</span><span>
</span><a name="line-186"></a><span>  </span><span class="hs-comment">-- The `sidTree` is left lazy.</span><span>
</span><a name="line-187"></a><span>  </span><a href="#local-1627459851"><span class="hs-identifier hs-var">qosTree</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-identifier hs-var">modifyMVarMasked_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerState</span><span> </span><a href="#local-1627459370"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459855"><a href="#local-1627459855"><span class="hs-identifier">bst</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-189"></a><span>      </span><span class="hs-identifier hs-var">modifyMVarMasked_</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionSubscriptions</span><span> </span><a href="#local-1627459371"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Network.MQTT.RoutingTree.html#unionWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unionWith</span></a><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-1627459851"><span class="hs-identifier hs-var">qosTree</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627459855"><span class="hs-identifier hs-var">bst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.RoutingTree.html#unionWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unionWith</span></a><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">union</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627459855"><span class="hs-identifier hs-var">bst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459852"><span class="hs-identifier hs-var">sidTree</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-193"></a><span>    </span><a href="Network.MQTT.Session.html#enqueueSubscribeAcknowledged"><span class="hs-identifier hs-var">Session</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">enqueueSubscribeAcknowledged</span></a><span> </span><a href="#local-1627459371"><span class="hs-identifier hs-var">session</span></a><span> </span><a href="#local-1627459372"><span class="hs-identifier hs-var">pid</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-1627459849"><span class="hs-identifier hs-var">checkedFilters</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>    </span><a name="local-1627459856"><a href="#local-1627459856"><span class="hs-identifier">rm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerRetainedMessages</span><span> </span><a href="#local-1627459370"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-comment">-- TODO: downgrade qos</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-identifier hs-var">forM_</span><span> </span><a href="#local-1627459850"><span class="hs-identifier hs-var">subscribeFilters</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627459857"><a href="#local-1627459857"><span class="hs-identifier">filtr</span></a></a><span class="hs-special">,</span><a name="local-1627459858"><a href="#local-1627459858"><span class="hs-identifier">_qos</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-197"></a><span>       </span><a href="Network.MQTT.Session.html#enqueueMessages"><span class="hs-identifier hs-var">Session</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">enqueueMessages</span></a><span> </span><a href="#local-1627459371"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.MQTT.RetainedMessages.html#lookupFilter"><span class="hs-identifier hs-var">RM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookupFilter</span></a><span> </span><a href="#local-1627459857"><span class="hs-identifier hs-var">filtr</span></a><span> </span><a href="#local-1627459856"><span class="hs-identifier hs-var">rm</span></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-199"></a><span>    </span><a name="local-1627459374"><a href="#local-1627459374"><span class="hs-identifier">checkPermission</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627459375"><a href="#local-1627459375"><span class="hs-identifier">filtr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1627459376"><a href="#local-1627459376"><span class="hs-identifier">qos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-200"></a><span>      </span><a name="local-1627459377"><a href="#local-1627459377"><span class="hs-identifier">isPermitted</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.MQTT.Authentication.html#hasSubscribePermission"><span class="hs-identifier hs-var">hasSubscribePermission</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerAuthenticator</span><span> </span><a href="#local-1627459370"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionPrincipal</span><span> </span><a href="#local-1627459371"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459375"><span class="hs-identifier hs-var">filtr</span></a><span>
</span><a name="line-201"></a><span>      </span><span class="hs-identifier hs-var">Log</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">debugM</span><span> </span><span class="hs-string">&quot;Broker.subscribe&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionPrincipal</span><span> </span><a href="#local-1627459371"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; subscribes &quot;</span><span>
</span><a name="line-202"></a><span>        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627459375"><span class="hs-identifier hs-var">filtr</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; with &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-1627459376"><span class="hs-identifier hs-var">qos</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-1627459377"><span class="hs-identifier hs-var">isPermitted</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;OK&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;FORBIDDEN&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-1627459375"><span class="hs-identifier hs-var">filtr</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-1627459377"><span class="hs-identifier hs-var">isPermitted</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-1627459376"><span class="hs-identifier hs-var">qos</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-identifier">unsubscribe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><a href="#local-1627458854"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Session.html#Session"><span class="hs-identifier hs-type">Session</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Session</span></a><span> </span><a href="#local-1627458854"><span class="hs-identifier hs-type">auth</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Message.html#PacketIdentifier"><span class="hs-identifier hs-type">PacketIdentifier</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Network.MQTT.Topic.html#Filter"><span class="hs-identifier hs-type">Filter</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-206"></a><a name="unsubscribe"><a href="Network.MQTT.Broker.html#unsubscribe"><span class="hs-identifier">unsubscribe</span></a></a><span> </span><a name="local-1627459859"><a href="#local-1627459859"><span class="hs-identifier">broker</span></a></a><span> </span><a name="local-1627459860"><a href="#local-1627459860"><span class="hs-identifier">session</span></a></a><span> </span><a name="local-1627459861"><a href="#local-1627459861"><span class="hs-identifier">pid</span></a></a><span> </span><a name="local-1627459862"><a href="#local-1627459862"><span class="hs-identifier">filters</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-207"></a><span>  </span><span class="hs-comment">-- Force the `unsubBrokerTree` first in order to lock the broker as little as possible.</span><span>
</span><a name="line-208"></a><span>  </span><a href="#local-1627459863"><span class="hs-identifier hs-var">unsubBrokerTree</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-identifier hs-var">modifyMVarMasked_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerState</span><span> </span><a href="#local-1627459859"><span class="hs-identifier hs-var">broker</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627459864"><a href="#local-1627459864"><span class="hs-identifier">bst</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-210"></a><span>      </span><span class="hs-identifier hs-var">modifyMVarMasked_</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionSubscriptions</span><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.RoutingTree.html#differenceWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">differenceWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627459863"><span class="hs-identifier hs-var">unsubBrokerTree</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627459864"><span class="hs-identifier hs-var">bst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.RoutingTree.html#differenceWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">differenceWith</span></a><span>
</span><a name="line-214"></a><span>                    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627459865"><a href="#local-1627459865"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Identity</span><span> </span><a name="local-1627459866"><a href="#local-1627459866"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span> </span><a href="#local-1627459866"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-1627459865"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627459864"><span class="hs-identifier hs-var">bst</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459863"><span class="hs-identifier hs-var">unsubBrokerTree</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-216"></a><span>    </span><a href="Network.MQTT.Session.html#enqueueUnsubscribeAcknowledged"><span class="hs-identifier hs-var">Session</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">enqueueUnsubscribeAcknowledged</span></a><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-var">session</span></a><span> </span><a href="#local-1627459861"><span class="hs-identifier hs-var">pid</span></a><span>
</span><a name="line-217"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-218"></a><span>    </span><a name="local-1627459863"><a href="#local-1627459863"><span class="hs-identifier">unsubBrokerTree</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.RoutingTree.html#insertFoldable"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insertFoldable</span></a><span>
</span><a name="line-219"></a><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-identifier hs-var">Identity</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">Session</span><span class="hs-operator">.</span><span class="hs-identifier">sessionIdentifier</span><span> </span><a href="#local-1627459860"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627459862"><span class="hs-identifier hs-var">filters</span></a><span> </span><span class="hs-special">)</span><span> </span><a href="Network.MQTT.RoutingTree.html#empty"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-220"></a></pre></body></html>