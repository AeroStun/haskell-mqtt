<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Module      :  Network.MQTT</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Copyright   :  (c) Lars Petersen 2016</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- License     :  MIT</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- Maintainer  :  info@lars-petersen.net</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- Stability   :  experimental</span><span>
</span><a name="line-10"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">Broker</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span class="hs-operator">.</span><span class="hs-identifier">Identity</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntSet</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IS</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntMap</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Sequence</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">MVar</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">BoundedChan</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Network.MQTT.TopicFilter.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">TopicFilter</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Network.MQTT.RoutingTree.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">MQTT</span><span class="hs-operator">.</span><span class="hs-identifier">RoutingTree</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">R</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">type</span><span> </span><a name="SessionKey"><a href="Network.MQTT.Broker.html#SessionKey"><span class="hs-identifier">SessionKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-28"></a><span class="hs-keyword">type</span><span> </span><a name="Message"><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier">Message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">newtype</span><span> </span><a name="Broker"><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier">Broker</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Broker"><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier">Broker</span></a></a><span>  </span><span class="hs-special">{</span><span> </span><a name="unBroker"><a href="Network.MQTT.Broker.html#unBroker"><span class="hs-identifier">unBroker</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-type">BrokerState</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-31"></a><span class="hs-keyword">newtype</span><span> </span><a name="Session"><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier">Session</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Session"><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier">Session</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unSession"><a href="Network.MQTT.Broker.html#unSession"><span class="hs-identifier">unSession</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><a href="Network.MQTT.Broker.html#SessionState"><span class="hs-identifier hs-type">SessionState</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">data</span><span> </span><a name="QosLevel"><a href="Network.MQTT.Broker.html#QosLevel"><span class="hs-identifier">QosLevel</span></a></a><span>
</span><a name="line-34"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="Qos0"><a href="Network.MQTT.Broker.html#Qos0"><span class="hs-identifier">Qos0</span></a></a><span>
</span><a name="line-35"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="Qos1"><a href="Network.MQTT.Broker.html#Qos1"><span class="hs-identifier">Qos1</span></a></a><span>
</span><a name="line-36"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="Qos2"><a href="Network.MQTT.Broker.html#Qos2"><span class="hs-identifier">Qos2</span></a></a><span>
</span><a name="line-37"></a><span>   </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">data</span><span> </span><a name="BrokerState"><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier">BrokerState</span></a></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a name="BrokerState"><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier">BrokerState</span></a></a><span>
</span><a name="line-41"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="brokerMaxSessionKey"><a href="Network.MQTT.Broker.html#brokerMaxSessionKey"><span class="hs-identifier">brokerMaxSessionKey</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Network.MQTT.Broker.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="brokerSubscriptions"><a href="Network.MQTT.Broker.html#brokerSubscriptions"><span class="hs-identifier">brokerSubscriptions</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.MQTT.RoutingTree.html#RoutingTree"><span class="hs-identifier hs-type">R</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">RoutingTree</span></a><span> </span><span class="hs-identifier hs-type">IS</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IntSet</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="brokerSessions"><a href="Network.MQTT.Broker.html#brokerSessions"><span class="hs-identifier">brokerSessions</span></a></a><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IM</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">IntMap</span><span> </span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-type">Session</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">data</span><span> </span><a name="SessionState"><a href="Network.MQTT.Broker.html#SessionState"><span class="hs-identifier">SessionState</span></a></a><span>
</span><a name="line-47"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a name="SessionState"><a href="Network.MQTT.Broker.html#SessionState"><span class="hs-identifier">SessionState</span></a></a><span>
</span><a name="line-48"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="sessionBroker"><a href="Network.MQTT.Broker.html#sessionBroker"><span class="hs-identifier">sessionBroker</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionKey"><a href="Network.MQTT.Broker.html#sessionKey"><span class="hs-identifier">sessionKey</span></a></a><span>                    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Network.MQTT.Broker.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionTermination"><a href="Network.MQTT.Broker.html#sessionTermination"><span class="hs-identifier">sessionTermination</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionSubscriptions"><a href="Network.MQTT.Broker.html#sessionSubscriptions"><span class="hs-identifier">sessionSubscriptions</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Network.MQTT.RoutingTree.html#RoutingTree"><span class="hs-identifier hs-type">R</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">RoutingTree</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Identity</span><span> </span><a href="Network.MQTT.Broker.html#QosLevel"><span class="hs-identifier hs-type">QosLevel</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionQueue0"><a href="Network.MQTT.Broker.html#sessionQueue0"><span class="hs-identifier">sessionQueue0</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">BoundedChan</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.TopicFilter.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionQueue1"><a href="Network.MQTT.Broker.html#sessionQueue1"><span class="hs-identifier">sessionQueue1</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">BoundedChan</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.TopicFilter.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sessionQueue2"><a href="Network.MQTT.Broker.html#sessionQueue2"><span class="hs-identifier">sessionQueue2</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">BoundedChan</span><span> </span><span class="hs-special">(</span><a href="Network.MQTT.TopicFilter.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier">newBroker</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span>
</span><a name="line-58"></a><a name="newBroker"><a href="Network.MQTT.Broker.html#newBroker"><span class="hs-identifier">newBroker</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-59"></a><span>  </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-var">Broker</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="Network.MQTT.Broker.html#BrokerState"><span class="hs-identifier hs-var">BrokerState</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerMaxSessionKey</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSessions</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-keyword">data</span><span> </span><a name="SessionConfig"><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier">SessionConfig</span></a></a><span>
</span><a name="line-66"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="SessionConfig"><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier">SessionConfig</span></a></a><span>
</span><a name="line-67"></a><span>     </span><span class="hs-special">{</span><span> </span><a name="sessionConfigQueue0MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue0MaxSize"><span class="hs-identifier">sessionConfigQueue0MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-68"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="sessionConfigQueue1MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue1MaxSize"><span class="hs-identifier">sessionConfigQueue1MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-69"></a><span>     </span><span class="hs-special">,</span><span> </span><a name="sessionConfigQueue2MaxSize"><a href="Network.MQTT.Broker.html#sessionConfigQueue2MaxSize"><span class="hs-identifier">sessionConfigQueue2MaxSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-70"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-identifier">createSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Broker.html#SessionConfig"><span class="hs-identifier hs-type">SessionConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-type">Session</span></a><span>
</span><a name="line-73"></a><a name="createSession"><a href="Network.MQTT.Broker.html#createSession"><span class="hs-identifier">createSession</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-var">Broker</span></a><span> </span><a name="local-1627456854"><a href="#local-1627456854"><span class="hs-identifier">broker</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627456855"><a href="#local-1627456855"><span class="hs-identifier">config</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-74"></a><span>  </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><a href="#local-1627456854"><span class="hs-identifier hs-var">broker</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456856"><a href="#local-1627456856"><span class="hs-identifier">brokerState</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-75"></a><span>    </span><a name="local-1627456857"><a href="#local-1627456857"><span class="hs-identifier">term</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-76"></a><span>    </span><a name="local-1627456858"><a href="#local-1627456858"><span class="hs-identifier">queue0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newBoundedChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionConfigQueue0MaxSize</span><span> </span><a href="#local-1627456855"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>    </span><a name="local-1627456859"><a href="#local-1627456859"><span class="hs-identifier">queue1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newBoundedChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionConfigQueue1MaxSize</span><span> </span><a href="#local-1627456855"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>    </span><a name="local-1627456860"><a href="#local-1627456860"><span class="hs-identifier">queue2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newBoundedChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionConfigQueue2MaxSize</span><span> </span><a href="#local-1627456855"><span class="hs-identifier hs-var">config</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1627456861"><a href="#local-1627456861"><span class="hs-identifier">newSessionKey</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">brokerMaxSessionKey</span><span> </span><a href="#local-1627456856"><span class="hs-identifier hs-var">brokerState</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-1627456862"><a href="#local-1627456862"><span class="hs-identifier">newSession</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-var">Session</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="Network.MQTT.Broker.html#SessionState"><span class="hs-identifier hs-var">SessionState</span></a><span>
</span><a name="line-81"></a><span>         </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sessionBroker</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-var">Broker</span></a><span> </span><a href="#local-1627456854"><span class="hs-identifier hs-var">broker</span></a><span>
</span><a name="line-82"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sessionKey</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456861"><span class="hs-identifier hs-var">newSessionKey</span></a><span>
</span><a name="line-83"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sessionTermination</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456857"><span class="hs-identifier hs-var">term</span></a><span>
</span><a name="line-84"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sessionSubscriptions</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Network.MQTT.RoutingTree.html#empty"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-85"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sessionQueue0</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456858"><span class="hs-identifier hs-var">queue0</span></a><span>
</span><a name="line-86"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sessionQueue1</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456859"><span class="hs-identifier hs-var">queue1</span></a><span>
</span><a name="line-87"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sessionQueue2</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456860"><span class="hs-identifier hs-var">queue2</span></a><span>
</span><a name="line-88"></a><span>         </span><span class="hs-special">}</span><span>
</span><a name="line-89"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-1627456863"><a href="#local-1627456863"><span class="hs-identifier">newBrokerState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456856"><span class="hs-identifier hs-var">brokerState</span></a><span>
</span><a name="line-90"></a><span>         </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerMaxSessionKey</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456861"><span class="hs-identifier hs-var">newSessionKey</span></a><span>
</span><a name="line-91"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSessions</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-1627456861"><span class="hs-identifier hs-var">newSessionKey</span></a><span> </span><a href="#local-1627456862"><span class="hs-identifier hs-var">newSession</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerSessions</span><span> </span><a href="#local-1627456856"><span class="hs-identifier hs-var">brokerState</span></a><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>         </span><span class="hs-special">}</span><span>
</span><a name="line-93"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-1627456863"><span class="hs-identifier hs-var">newBrokerState</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627456862"><span class="hs-identifier hs-var">newSession</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-identifier">closeSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-type">Session</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><a name="closeSession"><a href="Network.MQTT.Broker.html#closeSession"><span class="hs-identifier">closeSession</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-var">Session</span></a><span> </span><a name="local-1627456864"><a href="#local-1627456864"><span class="hs-identifier">session</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-1627456864"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456865"><a href="#local-1627456865"><span class="hs-identifier">sessionState</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unBroker</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sessionBroker</span><span> </span><a href="#local-1627456865"><span class="hs-identifier hs-var">sessionState</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456866"><a href="#local-1627456866"><span class="hs-identifier">brokerState</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-99"></a><span>      </span><span class="hs-comment">--tryPutMVar (sessionTermination sst) ()</span><span>
</span><a name="line-100"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1627456866"><span class="hs-identifier hs-var">brokerState</span></a><span>
</span><a name="line-101"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-102"></a><span>            </span><a href="Network.MQTT.RoutingTree.html#differenceWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">differenceWith</span></a><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">difference</span><span>
</span><a name="line-103"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627456866"><span class="hs-identifier hs-var">brokerState</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>              </span><span class="hs-special">(</span><span> </span><a href="Network.MQTT.RoutingTree.html#map"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sessionKey</span><span> </span><a href="#local-1627456865"><span class="hs-identifier hs-var">sessionState</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">sessionSubscriptions</span><span> </span><a href="#local-1627456865"><span class="hs-identifier hs-var">sessionState</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">brokerSessions</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-107"></a><span>            </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span>
</span><a name="line-108"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">sessionKey</span><span> </span><a href="#local-1627456865"><span class="hs-identifier hs-var">sessionState</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">brokerSessions</span><span> </span><a href="#local-1627456866"><span class="hs-identifier hs-var">brokerState</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-identifier">subscribeSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-type">Session</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Network.MQTT.TopicFilter.html#Filter"><span class="hs-identifier hs-type">Filter</span></a><span class="hs-special">,</span><span> </span><a href="Network.MQTT.Broker.html#QosLevel"><span class="hs-identifier hs-type">QosLevel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><a name="subscribeSession"><a href="Network.MQTT.Broker.html#subscribeSession"><span class="hs-identifier">subscribeSession</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-var">Session</span></a><span> </span><a name="local-1627456867"><a href="#local-1627456867"><span class="hs-identifier">session</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627456868"><a href="#local-1627456868"><span class="hs-identifier">filters</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-1627456867"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456869"><a href="#local-1627456869"><span class="hs-identifier">sessionState</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unBroker</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sessionBroker</span><span> </span><a href="#local-1627456869"><span class="hs-identifier hs-var">sessionState</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456870"><a href="#local-1627456870"><span class="hs-identifier">brokerState</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-116"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627456871"><a href="#local-1627456871"><span class="hs-identifier">newSessionState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456869"><span class="hs-identifier hs-var">sessionState</span></a><span>
</span><a name="line-117"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sessionSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span>
</span><a name="line-118"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627456872"><a href="#local-1627456872"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-1627456873"><a href="#local-1627456873"><span class="hs-identifier">q</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.RoutingTree.html#insertWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insertWith</span></a><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-1627456872"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Identity</span><span> </span><a href="#local-1627456873"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">sessionSubscriptions</span><span> </span><a href="#local-1627456869"><span class="hs-identifier hs-var">sessionState</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627456868"><span class="hs-identifier hs-var">filters</span></a><span>
</span><a name="line-120"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-121"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627456874"><a href="#local-1627456874"><span class="hs-identifier">newBrokerState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456870"><span class="hs-identifier hs-var">brokerState</span></a><span>
</span><a name="line-122"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span>
</span><a name="line-123"></a><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-1627456875"><a href="#local-1627456875"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.RoutingTree.html#insertWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insertWith</span></a><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">union</span><span> </span><a href="#local-1627456875"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">singleton</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sessionKey</span><span> </span><a href="#local-1627456869"><span class="hs-identifier hs-var">sessionState</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627456870"><span class="hs-identifier hs-var">brokerState</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627456868"><span class="hs-identifier hs-var">filters</span></a><span>
</span><a name="line-125"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-126"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-1627456874"><span class="hs-identifier hs-var">newBrokerState</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627456871"><span class="hs-identifier hs-var">newSessionState</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">unsubscribeSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-type">Session</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Network.MQTT.TopicFilter.html#Filter"><span class="hs-identifier hs-type">Filter</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><a name="unsubscribeSession"><a href="Network.MQTT.Broker.html#unsubscribeSession"><span class="hs-identifier">unsubscribeSession</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-var">Session</span></a><span> </span><a name="local-1627456876"><a href="#local-1627456876"><span class="hs-identifier">session</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627456877"><a href="#local-1627456877"><span class="hs-identifier">filters</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-130"></a><span>  </span><span class="hs-identifier hs-var">modifyMVar_</span><span> </span><a href="#local-1627456876"><span class="hs-identifier hs-var">session</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456878"><a href="#local-1627456878"><span class="hs-identifier">sessionState</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-131"></a><span>    </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unBroker</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sessionBroker</span><span> </span><a href="#local-1627456878"><span class="hs-identifier hs-var">sessionState</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456879"><a href="#local-1627456879"><span class="hs-identifier">brokerState</span></a></a><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-132"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627456880"><a href="#local-1627456880"><span class="hs-identifier">newSessionState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456878"><span class="hs-identifier hs-var">sessionState</span></a><span>
</span><a name="line-133"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sessionSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="Network.MQTT.RoutingTree.html#delete"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionSubscriptions</span><span> </span><a href="#local-1627456878"><span class="hs-identifier hs-var">sessionState</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627456877"><span class="hs-identifier hs-var">filters</span></a><span>
</span><a name="line-134"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-135"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-1627456881"><a href="#local-1627456881"><span class="hs-identifier">newBrokerState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1627456879"><span class="hs-identifier hs-var">brokerState</span></a><span>
</span><a name="line-136"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span>
</span><a name="line-137"></a><span>              </span><span class="hs-special">(</span><a href="Network.MQTT.RoutingTree.html#adjust"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">adjust</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">delete</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sessionKey</span><span> </span><a href="#local-1627456878"><span class="hs-identifier hs-var">sessionState</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627456879"><span class="hs-identifier hs-var">brokerState</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627456877"><span class="hs-identifier hs-var">filters</span></a><span>
</span><a name="line-139"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-1627456881"><span class="hs-identifier hs-var">newBrokerState</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627456880"><span class="hs-identifier hs-var">newSessionState</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- FIXME: What about downgrading message qos?</span><span>
</span><a name="line-143"></a><span class="hs-identifier">deliverSession</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Session"><span class="hs-identifier hs-type">Session</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.TopicFilter.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><a name="deliverSession"><a href="Network.MQTT.Broker.html#deliverSession"><span class="hs-identifier">deliverSession</span></a></a><span> </span><a name="local-1627456882"><a href="#local-1627456882"><span class="hs-identifier">session</span></a></a><span> </span><a name="local-1627456883"><a href="#local-1627456883"><span class="hs-identifier">topic</span></a></a><span> </span><a name="local-1627456884"><a href="#local-1627456884"><span class="hs-identifier">message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-145"></a><span>  </span><a name="local-1627456885"><a href="#local-1627456885"><span class="hs-identifier">sst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unSession</span><span> </span><a href="#local-1627456882"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Network.MQTT.RoutingTree.html#lookupWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookupWith</span></a><span> </span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-1627456883"><span class="hs-identifier hs-var">topic</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionSubscriptions</span><span> </span><a href="#local-1627456885"><span class="hs-identifier hs-var">sst</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Identity</span><span> </span><a href="Network.MQTT.Broker.html#Qos0"><span class="hs-identifier hs-var">Qos0</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-148"></a><span>      </span><a name="local-1627456886"><a href="#local-1627456886"><span class="hs-identifier">success</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryWriteChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionQueue0</span><span> </span><a href="#local-1627456885"><span class="hs-identifier hs-var">sst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627456883"><span class="hs-identifier hs-var">topic</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627456884"><span class="hs-identifier hs-var">message</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>      </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-1627456886"><span class="hs-identifier hs-var">success</span></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#closeSession"><span class="hs-identifier hs-var">closeSession</span></a><span> </span><a href="#local-1627456882"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Identity</span><span> </span><a href="Network.MQTT.Broker.html#Qos1"><span class="hs-identifier hs-var">Qos1</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-151"></a><span>      </span><a name="local-1627456887"><a href="#local-1627456887"><span class="hs-identifier">success</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryWriteChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionQueue1</span><span> </span><a href="#local-1627456885"><span class="hs-identifier hs-var">sst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627456883"><span class="hs-identifier hs-var">topic</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627456884"><span class="hs-identifier hs-var">message</span></a><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>      </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-1627456887"><span class="hs-identifier hs-var">success</span></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#closeSession"><span class="hs-identifier hs-var">closeSession</span></a><span> </span><a href="#local-1627456882"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Identity</span><span> </span><a href="Network.MQTT.Broker.html#Qos2"><span class="hs-identifier hs-var">Qos2</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-154"></a><span>      </span><a name="local-1627456888"><a href="#local-1627456888"><span class="hs-identifier">success</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryWriteChan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sessionQueue2</span><span> </span><a href="#local-1627456885"><span class="hs-identifier hs-var">sst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-1627456883"><span class="hs-identifier hs-var">topic</span></a><span class="hs-special">,</span><span> </span><a href="#local-1627456884"><span class="hs-identifier hs-var">message</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-1627456888"><span class="hs-identifier hs-var">success</span></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#closeSession"><span class="hs-identifier hs-var">closeSession</span></a><span> </span><a href="#local-1627456882"><span class="hs-identifier hs-var">session</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-identifier">publishBroker</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-type">Broker</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.TopicFilter.html#Topic"><span class="hs-identifier hs-type">Topic</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Broker.html#Message"><span class="hs-identifier hs-type">Message</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-159"></a><a name="publishBroker"><a href="Network.MQTT.Broker.html#publishBroker"><span class="hs-identifier">publishBroker</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.MQTT.Broker.html#Broker"><span class="hs-identifier hs-var">Broker</span></a><span> </span><a name="local-1627456889"><a href="#local-1627456889"><span class="hs-identifier">broker</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1627456890"><a href="#local-1627456890"><span class="hs-identifier">topic</span></a></a><span> </span><a name="local-1627456891"><a href="#local-1627456891"><span class="hs-identifier">message</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-160"></a><span>  </span><a name="local-1627456892"><a href="#local-1627456892"><span class="hs-identifier">brokerState</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-1627456889"><span class="hs-identifier hs-var">broker</span></a><span>
</span><a name="line-161"></a><span>  </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">elems</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.MQTT.RoutingTree.html#lookupWith"><span class="hs-identifier hs-var">R</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookupWith</span></a><span> </span><span class="hs-identifier hs-var">IS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">union</span><span> </span><a href="#local-1627456890"><span class="hs-identifier hs-var">topic</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">brokerSubscriptions</span><span> </span><a href="#local-1627456892"><span class="hs-identifier hs-var">brokerState</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-1627456893"><a href="#local-1627456893"><span class="hs-identifier">key</span></a></a><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">IM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><span class="hs-special">(</span><a href="#local-1627456893"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brokerSessions</span><span> </span><a href="#local-1627456892"><span class="hs-identifier hs-var">brokerState</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-163"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627456894"><a href="#local-1627456894"><span class="hs-identifier">session</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.MQTT.Broker.html#deliverSession"><span class="hs-identifier hs-var">deliverSession</span></a><span> </span><a href="#local-1627456894"><span class="hs-identifier hs-var">session</span></a><span> </span><a href="#local-1627456890"><span class="hs-identifier hs-var">topic</span></a><span> </span><a href="#local-1627456891"><span class="hs-identifier hs-var">message</span></a><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-comment">{-
type  SessionKey = Int

data  MqttBrokerSessions
   =  MqttBrokerSessions
      { maxSession    :: SessionKey
      , subscriptions :: SubscriptionTree
      , session       :: IM.IntMap MqttBrokerSession
      }


data  MqttBrokerSession
    = MqttBrokerSession
      { sessionBroker                  :: MqttBroker
      , sessionConnection              :: MVar (Async ())
      , sessionOutputBuffer            :: MVar RawMessage
      , sessionBestEffortQueue         :: BC.BoundedChan Message
      , sessionGuaranteedDeliveryQueue :: BC.BoundedChan Message
      , sessionInboundPacketState      :: MVar (IM.IntMap InboundPacketState)
      , sessionOutboundPacketState     :: MVar (IM.IntMap OutboundPacketState)
      , sessionSubscriptions           :: IS.Set TopicFilter
      }

data  Identity
data  InboundPacketState

data  OutboundPacketState
   =  NotAcknowledgedPublishQoS1 Message
   |  NotReceivedPublishQoS2     Message
   |  NotCompletePublishQoS2     Message

data MConnection
   = MConnection
     { msend    :: Message -&gt; IO ()
     , mreceive :: IO Message
     , mclose   :: IO ()
     }

publish :: MqttBrokerSession -&gt; Message -&gt; IO ()
publish session message = case qos message of
  -- For QoS0 messages, the queue will simply overflow and messages will get
  -- lost. This is the desired behaviour and allowed by contract.
  QoS0 -&gt;
    void $ BC.writeChan (sessionBestEffortQueue session) message
  -- For QoS1 and QoS2 messages, an overflow will kill the connection and
  -- delete the session. We cannot otherwise signal the client that we are
  -- unable to further serve the contract.
  _ -&gt; do
    success &lt;- BC.tryWriteChan (sessionGuaranteedDeliveryQueue session) message
    unless success undefined -- sessionTerminate session

dispatchConnection :: MqttBroker -&gt; Connection -&gt; IO ()
dispatchConnection broker connection =
  withConnect $ \clientIdentifier cleanSession keepAlive mwill muser j-&gt; do
    -- Client sent a valid CONNECT packet. Next, authenticate the client.
    midentity &lt;- brokerAuthenticate broker muser
    case midentity of
      -- Client authentication failed. Send CONNACK with `NotAuthorized`.
      Nothing -&gt; send $ ConnectAcknowledgement $ Left NotAuthorized
      -- Cient authenticaion successfull.
      Just identity -&gt; do
        -- Retrieve session; create new one if necessary.
        (session, sessionPresent) &lt;- getSession broker clientIdentifier
        -- Now knowing the session state, we can send the success CONNACK.
        send $ ConnectAcknowledgement $ Right sessionPresent
        -- Replace (and shutdown) existing connections.
        modifyMVar_ (sessionConnection session) $ \previousConnection-&gt; do
          cancel previousConnection
          async $ maintainConnection session `finally` close connection
  where
    -- Tries to receive the first packet and (if applicable) extracts the
    -- CONNECT information to call the contination with.
    withConnect :: (ClientIdentifier -&gt; CleanSession -&gt; KeepAlive -&gt; Maybe Will -&gt; Maybe (Username, Maybe Password) -&gt; BS.ByteString -&gt; IO ()) -&gt; IO ()
    withConnect  = undefined

    send :: RawMessage -&gt; IO ()
    send  = undefined

    maintainConnection :: MqttBrokerSession -&gt; IO ()
    maintainConnection session =
      processKeepAlive `race_` processInput `race_` processOutput
        `race_` processBestEffortQueue `race_` processGuaranteedDeliveryQueue

      where
        processKeepAlive = undefined
        processInput     = undefined
        processOutput    = undefined
        processBestEffortQueue = forever $ do
          message &lt;- BC.readChan (sessionBestEffortQueue session)
          putMVar (sessionOutputBuffer session) Publish
            { publishDuplicate = False
            , publishRetain    = retained message
            , publishQoS       = undefined -- Nothing
            , publishTopic     = topic message
            , publishBody      = payload message
            }
        processGuaranteedDeliveryQueue = undefined

getSession :: MqttBroker -&gt; ClientIdentifier -&gt; IO (MqttBrokerSession, SessionPresent)
getSession broker clientIdentifier =
  modifyMVar (brokerSessions broker) $ \ms-&gt;
    case M.lookup clientIdentifier ms of
      Just session -&gt; pure (ms, (session, True))
      Nothing      -&gt; do
        mthread &lt;- newMVar =&lt;&lt; async (pure ())
        session &lt;- MqttBrokerSession
          &lt;$&gt; pure broker
          &lt;*&gt; pure mthread
          &lt;*&gt; newEmptyMVar
          &lt;*&gt; BC.newBoundedChan 1000
          &lt;*&gt; BC.newBoundedChan 1000
          &lt;*&gt; newEmptyMVar
          &lt;*&gt; newEmptyMVar
        pure (M.insert clientIdentifier session ms, (session, False))
-}</span><span>
</span><a name="line-281"></a></pre></body></html>